function AnimQueue(a){this._fps=a,this._timer=0;var b=[];return this.restartTimer=function(){this._timer&&clearInterval(this._timer),this._timer=setInterval(this.tick,1e3/this._fps)},this.tick=function(a){if(this._fps){if(renderer.paused)return;a=1/this._fps}for(var c,d=b.length-1;-1!==d;d--)c=b[d],c.timeOut-=a,c.timeOut<=0&&(c.func(),b.splice(d,1));!b.length&&this._timer&&(clearInterval(this._timer),this._timer=0)}.bind(this),this.enqueue=function(a,c){var d={func:a,timeOut:c};b.push(d),this._fps&&!this._timer&&(this._timer=setInterval(this.tick,1e3/this._fps))},this.cancel=function(a){for(var c=b.length-1;-1!==c;c--){var d=b[c];if(d.func===a)return void b.splice(c,1)}},this.adjustTime=function(a,c){for(var d=b.length-1;-1!==d;d--){var e=b[d];if(e.func===a)return void(e.timeOut=c)}},this}function _deepClone(a,b){if("object"!=typeof a)return a;if(null===a)return null;if(_.isString(a))return a.splice();if(_.isDate(a))return new Date(a.getTime());if(_.isFunction(a.clone))return a.clone();var c=_.isArray(a)?a.slice():_.extend({},a);if(_.isArray(a))for(var d in a)a.hasOwnProperty(d)&&_.isUndefined(c[d])&&isNaN(d)&&(c[d]=a[d]);if(!_.isUndefined(b)&&b>0)for(var e in c)c[e]=_deepClone(c[e],b-1);return c}THREE.PixelBoxRenderer=function(){this.scene=null,this.webgl=null,this.clock=new THREE.Clock,this.paused=!1,this.init=function(a,b){var c,d=!1;try{c=document.createElement("canvas"),d=!!window.WebGLRenderingContext&&(c.getContext("webgl")||c.getContext("experimental-webgl"))}catch(e){}if(!d)return!1;this.scale=1/(void 0!=a?a:1),this.webgl=d=new THREE.WebGLRenderer({devicePixelRatio:1,antialias:!1,autoClear:!1,alpha:!1,maxLights:16,preserveDrawingBuffer:!1,precision:"highp"}),document.body.insertBefore(d.domElement,document.body.firstChild),d.updateStyle=!1,d.setSize(window.innerWidth*this.scale,window.innerHeight*this.scale),d.shadowMapEnabled=!0,d.sortObjects=!1,d.shadowMapSoft=!1,d.shadowMapType=THREE.BasicShadowMap;var f=!1,g=-1;if(d.setMaterialFaces=function(a){var b=a.side===THREE.DoubleSide,c=a.side===THREE.BackSide;"undefined"!=typeof a.flipSided&&(c=a.flipSided);var d=this.context;b?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),f=b,d.frontFace(c?d.CW:d.CCW),g=c}.bind(d),this.transitionParams={textureThreshold:.5,transitionDuration:1,useTexture:!1},b){var b=this.stats=new Stats;b.domElement.style.position="absolute",b.domElement.style.bottom="0px",b.domElement.style.right="0px",b.domElement.style.zIndex=100,document.body.appendChild(b.domElement),this.stats=b}return window.addEventListener("resize",this._resizeCallback,!0),c.style.width=window.innerWidth+"px",c.style.height=window.innerHeight+"px",this.animQueue=new AnimQueue(20),this.tweenQueue=new AnimQueue(!1),this._render(),!0},this.setScene=function(a,b,c){if(void 0!=b&&(this.scene instanceof THREE.PixelBoxSceneTransition&&this.scene.sceneB==a&&0!=b||this.scene==a))return void console.log("Same scene");var d=this.webgl.domElement.width,e=this.webgl.domElement.height;this.currentScene&&this.currentScene.fbo&&(this.currentScene.fbo.width!=d||this.currentScene.fbo.height!=e)&&this.currentScene.onResized&&this.currentScene.onResized(!0),a.fbo&&(a.fbo.width!=d||a.fbo.height!=e)&&a.onResized&&a.onResized(!0),this.currentScene=a,void 0!=b&&0!==b?(a.onWillAdd&&a.onWillAdd(),this.scene?this.scene instanceof THREE.PixelBoxSceneTransition&&this.setScene(this.scene.sceneB,0):this.scene=new THREE.PixelBoxEmptyScene(a.clearColor),this.scene.onWillRemove&&this.scene.onWillRemove(),this.transitionScene?this.transitionScene.init(this.scene,a):this.transitionScene=new THREE.PixelBoxSceneTransition(this.scene,a),this.transitionParams.transitionDuration=void 0!=c?c:1,b instanceof THREE.Texture?(this.transitionScene.setTexture(b),this.transitionScene.useTexture(!0)):this.transitionScene.useTexture(!1),this.transitionScene.setTextureThreshold(this.transitionParams.textureThreshold),this.transitionScene.onTransitionComplete=function(a){renderer.setScene(a,0)},this.scene=this.transitionScene):(this.scene instanceof THREE.PixelBoxSceneTransition&&this.scene.sceneA&&this.scene.sceneA.onRemoved?(this.scene.sceneA.onRemoved(),this.scene.sceneA=void 0):this.scene&&this.scene.onRemoved&&(void 0==b&&this.scene.onWillRemove&&this.scene.onWillRemove(),this.scene.onRemoved()),this.scene=a,void 0==b&&a.onWillAdd&&a.onWillAdd(),a.onAdded&&a.onAdded()),window.dispatchEvent(new Event("resize"))},this._render=function(){renderer.paused||requestAnimationFrame(renderer._render);var a=renderer.clock.getDelta();renderer.tweenQueue.tick(a),renderer.scene&&renderer.scene.render(a),renderer.stats&&renderer.stats.update()},this._resizeCallback=function(){renderer.webgl.domElement.style.width=window.innerWidth,renderer.webgl.domElement.style.height=window.innerHeight,renderer.resizeTimeout||(renderer.resizeTimeout=setTimeout(renderer._windowResized,100))},this._windowResized=function(){renderer.resizeTimeout=0,renderer.webgl.setSize(Math.floor(window.innerWidth*renderer.scale),Math.floor(window.innerHeight*renderer.scale)),THREE.PixelBoxUtil.updateViewPortUniform(),renderer.scene&&renderer.scene.onResized()},this.pause=function(a){this.paused=a,this.clock.getDelta(),this._render()}},THREE.PixelBoxEmptyScene=function(a){this.clearColor=void 0!=a?a:0,this.camera=new THREE.PerspectiveCamera(70,1,.1,1e4),this.scene=new THREE.Scene;var b={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat,generateMipmaps:!1,stencilBuffer:!1,depthBuffer:!1};this.fbo=new THREE.WebGLRenderTarget(renderer.webgl.domElement.width,renderer.webgl.domElement.height,b)},THREE.PixelBoxEmptyScene.prototype={constructor:THREE.PixelBoxEmptyScene,onWillAdd:function(){},onAdded:function(){},onWillRemove:function(){},onRemoved:function(){},onResized:function(){},render:function(a,b){renderer.webgl.setClearColor(this.clearColor,1),b?renderer.webgl.render(this.scene,this.camera,this.fbo,!0):renderer.webgl.render(this.scene,this.camera)}},THREE.PixelBoxSceneTransition=function(a,b){this.scene=new THREE.Scene,this.cameraOrtho=new THREE.OrthographicCamera(renderer.webgl.domElement.width/-2,renderer.webgl.domElement.width/2,renderer.webgl.domElement.height/2,renderer.webgl.domElement.height/-2,-1,1),this.quadmaterial=new THREE.ShaderMaterial({uniforms:{tScale:{type:"v2",value:new THREE.Vector2(1,1)},tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},mixRatio:{type:"f",value:0},threshold:{type:"f",value:.1},useTexture:{type:"i",value:1},tMixTexture:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2( uv.x, uv.y );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mixRatio;","uniform vec2 tScale;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tMixTexture;","uniform int useTexture;","uniform float threshold;","varying vec2 vUv;","void main() {","vec4 texel1 = texture2D( tDiffuse1, vUv );","vec4 texel2 = texture2D( tDiffuse2, vUv );","if (useTexture==1) {","vec4 transitionTexel = texture2D( tMixTexture, vec2(0.5 + (vUv.x - 0.5) * tScale.x, 0.5 + (vUv.y - 0.5) * tScale.y) );","float r = mixRatio * (1.0 + threshold * 2.0) - threshold;","float mixf=clamp((transitionTexel.r - r)*(1.0/threshold), 0.0, 1.0);","gl_FragColor = mix( texel2, texel1, mixf );","} else {","gl_FragColor = mix( texel1, texel2, mixRatio );","}","}"].join("\n")}),quadgeometry=new THREE.PlaneBufferGeometry(1,1),this.quad=new THREE.Mesh(quadgeometry,this.quadmaterial),this.scene.add(this.quad),this.init=function(a,b){this.onTransitionComplete=null,this.smoothTime=this.time=0,this.sceneA=a,this.sceneB=b,this.quadmaterial.uniforms.tDiffuse1.value=a.fbo,this.quadmaterial.uniforms.tDiffuse2.value=b.fbo;var c=renderer.webgl.domElement.width,d=renderer.webgl.domElement.height;this.quad.scale.set(c,d),this.quadmaterial.uniforms.tScale.value.set(Math.min(c/d,1),Math.min(d/c,1)),this.cameraOrtho.left=c/-2,this.cameraOrtho.right=c/2,this.cameraOrtho.top=d/2,this.cameraOrtho.bottom=d/-2,this.cameraOrtho.updateProjectionMatrix()},this.init(a,b),this.setTextureThreshold=function(a){this.quadmaterial.uniforms.threshold.value=a},this.useTexture=function(a){this.quadmaterial.uniforms.useTexture.value=a?1:0},this.setTexture=function(a){this.quadmaterial.uniforms.tMixTexture.value=a},this.render=function(a){var b=renderer.transitionParams;this.time+=a,this.smoothTime=THREE.Math.smoothstep(this.time,0,b.transitionDuration),this.quadmaterial.uniforms.mixRatio.value=this.smoothTime,0==this.smoothTime?this.sceneA.render(a,!1):1==this.smoothTime?(this.sceneB.render(a,!1),this.onTransitionComplete&&this.onTransitionComplete(this.sceneB)):(this.quadmaterial.uniforms.tDiffuse1.value=this.sceneA.fbo,this.quadmaterial.uniforms.tDiffuse2.value=this.sceneB.fbo,this.sceneA.render(a,!0),this.sceneB.render(a,!0),THREE.PixelBoxUtil.updateViewPortUniform(),renderer.webgl.render(this.scene,this.cameraOrtho,null,!0))},this.onResized=function(){var a=renderer.webgl.domElement.width,b=renderer.webgl.domElement.height;this.quad.scale.set(a,b),this.quadmaterial.uniforms.tScale.value.set(Math.min(a/b,1),Math.min(b/a,1)),this.cameraOrtho.left=a/-2,this.cameraOrtho.right=a/2,this.cameraOrtho.top=b/2,this.cameraOrtho.bottom=b/-2,this.cameraOrtho.updateProjectionMatrix(),this.sceneA.onResized(!0),this.sceneB.onResized(!0)}};var renderer=new THREE.PixelBoxRenderer;THREE.LinePath=function(){return THREE.Line.call(this,new THREE.Geometry,THREE.LinePath.prototype.sharedMaterial),this.path=new THREE.CurvePath,this.type=THREE.LineStrip,this},THREE.LinePath.prototype=Object.create(THREE.Line.prototype),THREE.LinePath.prototype.constructor=THREE.LinePath,THREE.LinePath.prototype.initialize=function(a){for(var b,c=null,d=0,e=a.segments.length;e>d;d++)seg=a.segments[d],b=new THREE.CubicBezierCurve3(c?c:(new THREE.Vector3).fromArray(seg.v0),(new THREE.Vector3).fromArray(seg.v1),(new THREE.Vector3).fromArray(seg.v2),(new THREE.Vector3).fromArray(seg.v3)),b.v0.lockTangents=seg.v0.length>3,b.v3.lockTangents=seg.v3.length>3,b.v0.meta=b.v0.meta?b.v0.meta:seg.metaStart,b.v3.meta=seg.metaEnd,c=b.v3,this.path.add(b);this.isLoop=this.path.curves[0].v0.equals(this.path.curves[this.path.curves.length-1].v3)},THREE.LinePath.prototype.getPoint=function(a){for(var b,c,d=a*this.path.getLength(),e=this.path.getCurveLengths(),f=0;f<e.length;){if(e[f]>=d){b=e[f]-d,c=this.path.curves[f];var g=1-b/c.getLength();return this.lastGetPointCurveIndex=f,c.getPointAt(g)}f++}return null},THREE.LinePath.prototype.reverse=function(){this.path.curves.reverse();for(var a=0,b=this.path.curves.length;b>a;a++){var c=this.path.curves[a],d=c.v0;c.v0=c.v3,c.v3=d,d=c.v1,c.v1=c.v2,c.v2=d}this.path.cacheLengths&&(this.path.cacheLengths.length=0)},THREE.LinePath.prototype.applyTween=function(a){var b=a.to-a.from,c=a.easing(a.time,a.from,b,a.duration),d=c%1,e=this.getPoint(d),f=1e-4*Math.sign(b);this.localToWorld(e);var g=null,h=null;if(this.lastGetPointCurveIndex!=a.currentCurveIndex){var i=this.path.curves[this.lastGetPointCurveIndex],j=void 0!==a.currentCurveIndex?this.path.curves[a.currentCurveIndex]:null;a.currentCurveIndex=this.lastGetPointCurveIndex,b>0?(i.v0.meta&&(g=i.v0.meta),j&&j.v3.meta&&j.v3!=i.v0&&(h=j.v3.meta)):(i.v3.meta&&(g=i.v3.meta),j&&j.v0.meta&&j.v0!=i.v3&&(h=j.v0.meta))}if(g){a.meta&&a.meta.call(this,a,g);var k={type:"path-meta",tweenObject:a,meta:g};a.target.dispatchEvent(k),this.dispatchEvent(k)}if(h){a.meta&&a.meta.call(this,a,h);var k={type:"path-meta",tweenObject:a,meta:h};a.target.dispatchEvent(k),this.dispatchEvent(k)}var l=a.target.parent;l&&a.target.parent.worldToLocal(e);a.target.position.clone();a.target.position.copy(e);{var m=d+f;a.target.rotation.clone()}if(a.orientToPath&&m>0&&(this.isLoop||1>=m)){var n=this.getPoint(m%1);this.localToWorld(n),l&&l.worldToLocal(n),a.target.lookAt(n)}a.target.syncBody()},THREE.LinePath.prototype.tween=function(a){var b;b=_.isArray(a)?a.concat():[a];for(var c=b.length-1;c>=0;c--){var d=b[c];void 0!==d.target?d.target instanceof THREE.Object3D?this.isDescendantOf(d.target)&&(console.log("tween object 'target' must not be a parent/ascendant of this THREE.LinePath instance: ",d),b.splice(c,1)):(console.log("tween object 'target' must be a descendant of THREE.Object3D: ",d),b.splice(c,1)):(console.log("tween object 'target' parameter is missing: ",d),b.splice(c,1))}return THREE.Object3D.prototype.tween.call(this,b)},THREE.PixelBoxScene=function(){THREE.Scene.call(this),this.clearColor=0,this.scene=this,this.fog=new THREE.Fog(0,1e5,1e7),this.ambientLight=new THREE.AmbientLight(0),this.add(this.ambientLight),this.updateLights=!0,this.updateMaterials=!0,this._camera=new THREE.PerspectiveCamera(60,renderer.webgl.domElement.width/renderer.webgl.domElement.height,1,2e6),this._camera.name="camera",this._camera.position.set(70,70,70),this._camera.lookAt(0,0,0),this.add(this._camera),Object.defineProperty(this,"camera",{get:function(){return this._camera},set:function(a){this._camera=a,this.onCameraChanged(a)}});var a={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat,stencilBuffer:!1};if(this.fbo=new THREE.WebGLRenderTarget(renderer.webgl.domElement.width,renderer.webgl.domElement.height,a),this.screenPass){if(!(THREE.EffectComposer&&THREE.RenderPass&&THREE.CopyShader&&THREE.MaskPass&&THREE.ShaderPass))throw"Using .screenPass requires the following THREE.js classes: THREE.EffectComposer, THREE.RenderPass, THREE.MaskPass, THREE.ShaderPass, THREE.CopyShader.";this.composer=new THREE.EffectComposer(renderer.webgl,this.fbo),this.composer.renderPass=new THREE.RenderPass(this,this.camera),this.composer.addPass(this.composer.renderPass),"object"!=typeof this.screenPass&&(this.screenPass=new THREE.PixelBoxScreenPass(this)),this.composer.addPass(this.screenPass)}return this.raycaster=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3,.01,this.camera.far),this.floorPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0),this.objectPool={},this},THREE.PixelBoxScene.prototype=Object.create(THREE.Scene.prototype),THREE.PixelBoxScene.prototype.constructor=THREE.PixelBoxScene,THREE.PixelBoxScene.prototype.onAdded=function(){},THREE.PixelBoxScene.prototype.onWillAdd=function(){},THREE.PixelBoxScene.prototype.onWillRemove=function(){},THREE.PixelBoxScene.prototype.onRemoved=function(){},THREE.PixelBoxScene.prototype.tick=function(){},THREE.PixelBoxScene.prototype.instantiate=function(a,b){var c=this.templates[a];if(c){b=b?b:{},b.templates=this.templates;var d=this.populateObject(null,[{asset:"Instance",name:a,template:a}],b);if(d.length){var e=d[0];return this.linkObjects(d,e),e}return console.log("Instantiate "+a+" failed"),null}console.log("Template "+a+" not found in scene definiton")},THREE.PixelBoxScene.prototype.recycle=function(a){_.isArray(a)||(a=[a]);for(var b,c,d=!1,e=0,f=a.length;f>e;e++){var c=a[e];b=c.recursiveRemoveChildren(),c.parent&&(c.name&&(c.anchored&&c.parent.parent&&c.parent.parent[c.name]==c?delete c.parent.parent[c.name]:c.parent[c.name]==c&&delete c.parent[c.name]),c.parent.remove(c)),b.push(c);for(var g=0,h=b.length;h>g;g++){c=b[g];var i=null;c instanceof THREE.PixelBox?i=c.geometry.data.name:c instanceof THREE.FxSprite?i="FxSprite":c instanceof THREE.DirectionalLight?(i="DirectionalLight",d=!0):c instanceof THREE.HemisphereLight?(i="HemisphereLight",d=!0):c instanceof THREE.PointLight?(i="PointLight",d=!0):c instanceof THREE.SpotLight?(i="SpotLight",d=!0):c instanceof THREE.Mesh?i="Geometry":c instanceof THREE.PerspectiveCamera?i="Camera":c instanceof THREE.OrthographicCamera?i="OrthographicCamera":c instanceof THREE.LinePath?i="LinePath":c instanceof THREE.Object3D&&c.isContainer&&(i="Object3D"),i?this.objectPool[i]?this.objectPool[i].push(c):this.objectPool[i]=[c]:c.dispose&&c.dispose()}}d&&(this.updateLights=!0)},THREE.PixelBoxScene.prototype.upcycle=function(a){var b=null;return this.objectPool[a]&&this.objectPool[a].length&&(b=this.objectPool[a][this.objectPool[a].length-1],this.objectPool[a].pop()),b},THREE.PixelBoxScene.prototype.populateWith=function(a){if(!a)throw"Invalid sceneDef.";var b=!1;for(var c in a.assets)if(void 0===assets.get(c)){var d=a.assets[c];if("string"==typeof d){var e=LZString.decompressFromBase64(d);if(!e){console.error("Failed to LZString decompressFromBase64: ",d);continue}try{d=JSON.parse(e)}catch(f){console.error("Failed to parse JSON ",f,e)}}else d=_deepClone(d,100);if(d.includedWithScene=this,d.src){var g=document.createElement("img"),h=new THREE.Texture(g);g.onload=g.onLoad=function(){h.needsUpdate=!0},g.src=d.src,assets.add(c,h),b=!0}else d.xml?assets.add(c,THREE.PixelBoxUtil.parseXml(d.xml)):d.plist?assets.add(c,THREE.PixelBoxUtil.parsePlist(d.plist)):assets.add(c,d)}var i=null,j=null;2==arguments.length?"function"==typeof arguments[1]?j=arguments[1]:i=arguments[1]:3==arguments.length&&(i=arguments[1],j=arguments[2]);var k=function(a,b,c){function d(a,b,c){return a&&void 0!==a[b]?a[b]:c}if(this.clearColor=parseInt(d(a,"clearColor","0"),16),this.fog.color.set(parseInt(d(a,"fogColor","0"),16)),this.fog.near=d(a,"fogNear",1e5),this.fog.far=d(a,"fogFar",1e7),this.ambientLight.color.set(parseInt(d(a,"ambient","0"),16)),this.physics=a.physics,"CANNON"===a.physics){if(!window.CANNON)throw"Scene definition has physics set to CANNON, but CANNON library is not included. http://schteppe.github.io/cannon.js/";this.world=new CANNON.World,this.world.allMaterials={},this.world.quatNormalizeFast=!0,this.world.collideEventDispatch=this.CANNON_dispatchObjectsCollision.bind(this),this.world.broadphase="SAPBroadphase"===a.broadphase?new CANNON.SAPBroadphase:new CANNON.NaiveBroadphase,this.world.gravity.set(a.gravity[0],a.gravity[1],a.gravity[2]),this.objectRemovedFromWorld=this.objectRemovedFromWorld.bind(this),this.objectAddedToWorld=this.objectAddedToWorld.bind(this)}b=b?b:{},this.templates=b.templates=a.templates;var e=this.populateObject(this,a.layers?a.layers:[],b);this.updateMatrixWorld(!0),this.linkObjects(e,this);var f=0;this.staticGroups={};for(var g=e.length-1;g>=0;g--){var h=e[g];if((h instanceof THREE.DirectionalLight||h instanceof THREE.SpotLight)&&h.castShadow&&f++,h instanceof THREE.PixelBox&&h.staticGroup&&h.visible){h.updateMatrixWorld(!0);var i=this.staticGroups[h.staticGroup];i||(this.staticGroups[h.staticGroup]=i=new THREE.PixelBox({staticGroup:h.staticGroup,pointSize:h.pointSize,width:1,depth:1,height:1}),i.position.copy(h.position),h.parent.localToWorld(i.position),this.add(i),i.updateMatrixWorld(!0)),i.appendPixelBox(h);var j=h.nearestParentWithoutProperty("staticGroup");for(j||(j=this);h.children.length;){var k=h.children[h.children.length-1];h.children.pop(),k.transplant(j)}h.parent&&h.parent.remove(h),h.visible=!1,h.dispose()}}for(var l in this.staticGroups){var i=this.staticGroups[l];THREE.PixelBoxUtil.finalizeFrames(i.geometry.data,new THREE.Vector3,!0),i.frame=0}var m=Math.max(0,a.maxShadows-f);this.placeHolderLights=[];for(var n;m;)n=this.placeHolderLights.length?new THREE.SpotLight(0,1):new THREE.DirectionalLight(0,1),n.castShadow=!0,n.shadowMapWidth=n.shadowMapHeight=128,this.add(n),this.placeHolderLights.push(n),m--;"CANNON"===a.physics&&"SAPBroadphase"==a.broadphase&&this.world&&this.world.broadphase.autoDetectAxis(),c&&c()}.bind(this);b?setTimeout(function(){k(a,i,j)},100):k(a,i,j)},THREE.PixelBoxScene.prototype.populateObject=function(a,b,c){var d=Math.PI/180,e=[];c=c?c:{};for(var f=0;f<b.length;f++){var g=b[f],h=null,i=null;if(!g.collisionShape&&!g.constraint){if(c.makeObject&&(h=c.makeObject(g),-1===h))continue;h||"Instance"==g.asset||(h=this.upcycle(g.asset))}switch(g.asset){case"Instance":if(!h){var j=_.clone(c);if(j.helpers=!1,c.templates&&c.templates[g.template]){var k,l=c.templates[g.template];if(c.wrapTemplates){h=new THREE.Object3D,h.isInstance=!0,h.isTemplate=!1,k=this.populateObject(h,[l],j);var m=k[0];this.linkObjects(k,m,!!c.skipProps),m.omit=!0,m.position.set(0,0,0),m.rotation.set(0,0,0),m.scale.set(1,1,1),m.visible=!0,e=e.concat(k)}else{var n=_.clone(l);n.position=g.position,n.rotation=g.rotation,n.scale=g.scale,n.name=g.name,k=this.populateObject(a,[n],j),h=k[0],h.isInstance=!0,h.isTemplate=!1,this.linkObjects(k,h,!!c.skipProps),k.splice(0,1),e=e.concat(k)}h.castShadow=void 0!=l.castShadow?l.castShadow:!0,h.receiveShadow=void 0!=l.receiveShadow?l.receiveShadow:!0}else console.log("Template "+g.template+" not found"),h||(h=new THREE.Object3D)}break;case"Camera":h||(h=new THREE.PerspectiveCamera(60,1,1,1e3)),void 0!=g.fov&&(h.fov=g.fov),void 0!=g.near&&(h.near=g.near),void 0!=g.far&&(h.far=g.far),h.isDefault=g.isDefault?!0:!1,!c.keepSceneCamera&&h.isDefault&&(this.camera&&this.camera.parent&&this.camera.parent.remove(this.camera),this.camera=h),c.helpers&&(i=new THREE.CameraHelper(h));break;case"OrthographicCamera":var o=64;if(c.keepSceneCamera)h=new THREE.OrthographicCamera(-o,o,o,-o,1,1e3);else{var p=.22*renderer.webgl.domElement.width,q=.22*renderer.webgl.domElement.height;h||(h=new THREE.OrthographicCamera(-p,p,q,-q,1,1e3))}void 0!=g.zoom&&(h.zoom=g.zoom,h.updateProjectionMatrix()),g.isDefault&&this instanceof THREE.PixelBoxScene&&!this.camera.def&&(this.camera.parent.remove(this.camera),this.camera=h),h.isDefault=g.isDefault?!0:!1,!c.keepSceneCamera&&h.isDefault&&(this.camera&&this.camera.parent&&this.camera.parent.remove(this.camera),this.camera=h),c.helpers&&(i=new THREE.CameraHelper(h));break;case"DirectionalLight":h||(h=new THREE.DirectionalLight(16777215,1)),h.shadowMapWidth=h.shadowMapHeight=1024,h.shadowCameraNear=void 0!=g.shadowNear?g.shadowNear:1,h.shadowCameraFar=void 0!=g.shadowFar?g.shadowFar:1e4,h.shadowCameraRight=.5*(void 0!=g.shadowVolumeWidth?g.shadowVolumeWidth:256),h.shadowCameraLeft=-h.shadowCameraRight,h.shadowCameraTop=.5*(void 0!=g.shadowVolumeHeight?g.shadowVolumeHeight:2*h.shadowCameraRight),h.shadowCameraBottom=-h.shadowCameraTop,h.shadowBias=void 0!=g.shadowBias?g.shadowBias:-5e-4,h.shadowMap&&(h.shadowMap.dispose(),h.shadowMap=null),h.shadowCamera&&(h.shadowCamera.parent&&h.shadowCamera.parent.remove(h.shadowCamera),h.shadowCamera=null),void 0!=g.color&&h.color.set(parseInt(g.color,16)),void 0!=g.intensity&&(h.intensity=g.intensity),void 0!=g.shadowMapWidth&&(h.shadowMapWidth=h.shadowMapHeight=g.shadowMapWidth),void 0!=g.shadowMapHeight&&(h.shadowMapHeight=g.shadowMapHeight),void 0!=g.target&&_.isArray(g.target)&&3==g.target.length&&(h.target=new THREE.Object3D,h.target.position.fromArray(g.target)),c.helpers&&(i=new THREE.DirectionalLightHelper(h,5));break;case"SpotLight":h||(h=new THREE.SpotLight(16777215,1,100,Math.PI/3,70)),h.shadowMapWidth=h.shadowMapHeight=1024,h.shadowCameraNear=void 0!=g.shadowNear?g.shadowNear:1,h.shadowCameraFar=void 0!=g.shadowFar?g.shadowFar:h.distance,h.shadowBias=void 0!=g.shadowBias?g.shadowBias:-5e-4,h.shadowMap&&(h.shadowMap.dispose(),h.shadowMap=null),h.shadowCamera&&(h.shadowCamera.parent&&h.shadowCamera.parent.remove(h.shadowCamera),h.shadowCamera=null),void 0!=g.color&&h.color.set(parseInt(g.color,16)),void 0!=g.intensity&&(h.intensity=g.intensity),void 0!=g.distance&&(h.distance=g.distance),void 0!=g.exponent&&(h.exponent=g.exponent),void 0!=g.angle&&(h.angle=g.angle*d,h.shadowCameraFov=2*g.angle),void 0!=g.shadowMapWidth&&(h.shadowMapWidth=h.shadowMapHeight=g.shadowMapWidth),void 0!=g.shadowMapHeight&&(h.shadowMapHeight=g.shadowMapHeight),void 0!=g.target&&_.isArray(g.target)&&3==g.target.length&&(h.target=new THREE.Object3D,h.target.position.fromArray(g.target)),c.helpers&&(i=new THREE.SpotLightHelper(h,5));break;case"PointLight":h||(h=new THREE.PointLight(16777215,1)),void 0!=g.color&&h.color.set(parseInt(g.color,16)),void 0!=g.intensity&&(h.intensity=g.intensity),void 0!=g.distance&&(h.distance=g.distance),c.helpers&&(i=new THREE.PointLightHelper(h,5));break;case"HemisphereLight":h||(h=new THREE.HemisphereLight(16777215,13158,.5)),g.colors&&(h.color.set(parseInt(g.colors[0],16)),h.groundColor.set(parseInt(g.colors[1],16))),void 0!=g.intensity&&(h.intensity=g.intensity);break;case"Object3D":h||(h=new THREE.Object3D),h.isContainer=!0;break;case"LinePath":h||(h=new THREE.LinePath),h.initialize(g,c);break;case"Geometry":var r,s;if(g.collisionShape||g.constraint){if(!(a instanceof THREE.Mesh||a.isContainer||a.isAnchor||a instanceof THREE.PixelBox))continue;if(!c.helpers)continue;s=this.makeGeometryObject(g,!0),r=new THREE.MeshBasicMaterial({color:16737792,wireframe:!0,side:THREE.DoubleSide}),g.collisionShape&&a&&r.color.set("2"==a.def.bodyType?26367:"1"==a.def.bodyType?6710886:16777215),h=new THREE.Mesh(s,r),h.collisionShape=g.collisionShape,h.constraint=g.constraint,h.geometryType=g.mesh,g.collideConnected&&(h.collideConnected=!0),void 0!=g.motorTargetVelocity&&(h.motorTargetVelocity=g.motorTargetVelocity)}else{if(s=this.makeGeometryObject(g),h){h.geometry.dispose(),h.geometry=s,r=h.material;var t=renderer.webgl.context;for(var u in s.attributes){var v="index"===u?t.ELEMENT_ARRAY_BUFFER:t.ARRAY_BUFFER,w=s.attributes[u];if(!w.buffer){w.buffer=t.createBuffer();{t.bindBuffer(v,w.buffer)}t.bufferData(v,w.array,t.STATIC_DRAW)}}}else r=new THREE.MeshPixelBoxMaterial,h=new THREE.Mesh(s,r),h.customDepthMaterial=THREE.PixelBoxUtil.meshDepthMaterial.clone(),h.customDepthMaterial.uniforms.map=r.uniforms.map,h.customDepthMaterial.uniforms.tintAlpha=r.uniforms.tintAlpha,h.customDepthMaterial.uniforms.uvSliceRect=r.uniforms.uvSliceRect,h.customDepthMaterial.uniforms.uvSliceOffset=r.uniforms.uvSliceOffset,h.customDepthMaterial.uniforms.uvSliceSizeIsRotated=r.uniforms.uvSliceSizeIsRotated,h.customDepthMaterial._shadowPass=!0,h._textureMap=null,Object.defineProperty(h,"textureMap",{get:function(){return this._textureMap},set:function(a){this._textureMap=a;var b=assets.get(a);this.material.needsUpdate=this.customDepthMaterial.needsUpdate=!0,b?b instanceof THREE.Texture?(this.customDepthMaterial.map=this.material.map=b,b.needsUpdate=!0):b.image&&(b.texture||(b.texture=new THREE.Texture(b.image)),this.customDepthMaterial.map=this.material.map=b.texture,b.texture.needsUpdate=!0):this.customDepthMaterial.map=this.material.map=null,this.customDepthMaterial.needsUpdate=!0,this.sliceName=this._sliceName}}),h._sliceName=null,Object.defineProperty(h,"sliceName",{get:function(){return this._sliceName},set:function(a){this._sliceName=a;var b=assets.get(this._textureMap);if(b){var c=b.sliceMap;if(!c){for(var d in assets.files){var e=assets.files[d];if(e.metadata&&e.metadata.textureFileName==this._textureMap){c=b.sliceMap=e;break}if(e.plist&&e.plist.metadata&&e.plist.metadata.textureFileName==this._textureMap){c=b.sliceMap=e.plist;break}}if(!c)return void(this.material.slice=null)}this.material.slice=c.frames[a]}}});h.geometryType=g.mesh,r.side="Plane"==g.mesh?THREE.DoubleSide:g.inverted?THREE.BackSide:THREE.FrontSide,r.tint.set(void 0!=g.tint?parseInt(g.tint,16):16777215),r.addColor.set(void 0!=g.addColor?parseInt(g.addColor,16):0),r.alpha=void 0!=g.alpha?g.alpha:1,r.alphaThresh=void 0!=g.alphaThresh?g.alphaThresh:0,r.brightness=void 0!=g.brightness?g.brightness:0,r.stipple=void 0!=g.stipple?g.stipple:0,h.textureMap=g.textureMap?g.textureMap:null,h.sliceName=g.sliceName?g.sliceName:null}break;case"FxSprite":h?h.reset():h=new THREE.FxSprite;var r=h.material;r.tint.set(void 0!=g.tint?parseInt(g.tint,16):16777215),r.addColor.set(void 0!=g.addColor?parseInt(g.addColor,16):0),r.alpha=void 0!=g.alpha?g.alpha:1,r.alphaThresh=void 0!=g.alphaThresh?g.alphaThresh:0,r.brightness=void 0!=g.brightness?g.brightness:0,r.stipple=void 0!=g.stipple?g.stipple:0,h.textureMap=g.textureMap?g.textureMap:null,h.fxData=g.fxData?g.fxData:null,h.scaleX=g.scaleX?g.scaleX:1,h.scaleY=g.scaleY?g.scaleY:1,h.angle=g.angle?g.angle:0;break;default:var x=assets.get(g.asset);if(x)h||(h=new THREE.PixelBox(x)),h.staticGroup=g.staticGroup;else if(console.log("Deferred loading of "+g.asset),!h){h=new THREE.Object3D,h.isPlaceholder=!0;var y=new THREE.AxisHelper(1);y.isHelper=!0,h.add(y)}}if(g=h.def=_deepClone(g,100),g.name&&(h.name=g.name),void 0!=c.position&&(g.position=c.position,c.position=null),void 0!=c.rotation&&(g.rotation=c.rotation,c.rotation=null),void 0!=c.scale&&(g.scale=c.scale,c.scale=null),g.position?_.isArray(g.position)?h.position.fromArray(g.position):h.position.copy(g.position):h instanceof THREE.HemisphereLight||h.position.set(0,0,0),g.rotation?_.isArray(g.rotation)?h.rotation.set(g.rotation[0]*d,g.rotation[1]*d,g.rotation[2]*d):h.rotation.copy(g.rotation):h.rotation.set(0,0,0),g.scale?_.isArray(g.scale)?h.scale.fromArray(g.scale):"object"==typeof g.scale?h.scale.copy(g.scale):h.scale.set(g.scale,g.scale,g.scale):h.scale.set(1,1,1),void 0!=g.castShadow&&(h.castShadow=g.castShadow),void 0!=g.receiveShadow&&(h.receiveShadow=g.receiveShadow),h instanceof THREE.FxSprite&&h.cascadeColorChange(),i&&(this.scene.add(i),h.helper=i,i.isHelper=!0,i.update(),i.visible=!1),h.visible=void 0!=g.visible?g.visible:!0,void 0!=g.animSpeed&&(h.animSpeed=g.animSpeed),void 0!=g.animName&&void 0!=h.animNamed(g.animName)){var z=g.animOption?g.animOption:"gotoAndStop",A=void 0!=g.animFrame?g.animFrame:0;"loopAnim"==z?h.loopAnim(g.animName,1/0,!1):"loopFrom"==z?(h.gotoAndStop(g.animName,A+1),h.loopAnim(g.animName,1/0,!0)):"playAnim"==z?h.playAnim(g.animName):h.gotoAndStop(g.animName,A)}else void 0!=g.animFrame&&(h.stopAnim(),h.frame=g.animFrame);if(!h.isInstance&&h instanceof THREE.PixelBox){void 0!=g.pointSize&&(h.pointSize=g.pointSize),h.alpha=void 0!=g.alpha?g.alpha:1,void 0!=g.cullBack&&(h.cullBack=g.cullBack),void 0!=g.occlusion&&(h.occlusion=g.occlusion),h.tint.set(void 0!=g.tint?parseInt(g.tint,16):16777215),h.addColor.set(void 0!=g.add?parseInt(g.add,16):0),h.stipple=void 0!=g.stipple?g.stipple:0;for(var y in h.anchors)h.anchors[y].parent||h.add(h.anchors[y])}var B=g.name&&!c.noNameReferences&&a;B&&a[g.name]!=h&&(a[g.name]?("camera"==g.name&&("camera"!=g.name||h instanceof THREE.Camera)||console.log("Warning: ",a,"["+g.name+"] already exists. Overwriting."),a[g.name]=h):a[g.name]=h),e.splice(0,0,h);var C=!h.parent&&a;if(C&&(g.anchor&&a.anchors?a.anchors[g.anchor].add(h):a.add(h),h.anchored=g.anchor?g.anchor:!1),h.updateMatrixWorld(!0),h.physics=!!g.physics,h.physics&&g.layers&&this.initObjectPhysics(h,g),this.world&&(h.addEventListener("removed",this.objectRemovedFromWorld),h.addEventListener("added",this.objectAddedToWorld)),!h.isInstance&&!h.parentInstance()&&(g.isTemplate&&(h.isTemplate=g.isTemplate),g.containsTemplates&&c.templates))for(var D=0;D<g.containsTemplates.length;D++){var E=c.templates[g.containsTemplates[D]],F=[];if(E){var G=h.children.length;F=F.concat(this.populateObject(h,[c.templates[g.containsTemplates[D]]],c)),this.linkObjects(F,h.children[G],!!c.skipProps),e=e.concat(F)}}g.layers&&(e=e.concat(this.populateObject(h,g.layers,c))),c.initObject&&c.initObject.call(this,h,g)}return e},THREE.PixelBoxScene.prototype.makeGeometryObject=function(a,b){function c(b,c,d,e){var f;return f=void 0!==a[b]?a[b]:c,void 0!==d&&(f=Math.max(d,f)),void 0!==e&&(f=Math.min(e,f)),f}var d,e=Math.PI/180;switch(a.mesh){case"Sphere":a.radius=c("radius",5),a.widthSegments=b?10:c("widthSegments",8,3),a.heightSegments=b?10:c("heightSegments",6,2),a.phiStart=c("phiStart",0),a.phiLength=c("phiLength",360),a.thetaStart=c("thetaStart",0),a.thetaLength=c("thetaLength",180),d=new THREE.SphereGeometry(a.radius,a.widthSegments,a.heightSegments,a.phiStart*e,a.phiLength*e,a.thetaStart*e,a.thetaLength*e);break;case"Cylinder":a.radiusTop=c("radiusTop",10),a.radiusBottom=c("radiusBottom",10),a.height=c("height",10),a.radiusSegments=c("radiusSegments",10,3),a.heightSegments=b?1:c("heightSegments",1,1),a.openEnded=b?!1:c("openEnded",!1),d=new THREE.CylinderGeometry(a.radiusTop,a.radiusBottom,a.height,a.radiusSegments,a.heightSegments,a.openEnded);break;case"Box":a.widthSegments=b?1:c("widthSegments",1,1),a.heightSegments=b?1:c("heightSegments",1,1),a.depthSegments=b?1:c("depthSegments",1,1),a.width=c("width",10),a.height=c("height",10),a.depth=c("depth",10),d=new THREE.BoxGeometry(a.width,a.height,a.depth,a.widthSegments,a.heightSegments,a.depthSegments);
break;case"Plane":default:if(a.widthSegments=b?1:c("widthSegments",1,1),a.heightSegments=b?1:c("heightSegments",1,1),a.width=c("width",10),a.height=c("height",10),d=a.inverted||b?new THREE.PlaneGeometry(a.width,a.height,a.widthSegments,a.heightSegments):new THREE.PlaneBufferGeometry(a.width,a.height,a.widthSegments,a.heightSegments),b){var f=new THREE.CylinderGeometry(0,2,5,3,1,!0);d.merge(f,(new THREE.Matrix4).makeRotationX(.5*Math.PI),0)}break;case"Particle":d=new THREE.TetrahedronGeometry(.5,0);break;case"HingeConstraint":d=new THREE.CylinderGeometry(1,1,10,3,1,!0);break;case"PointToPointConstraint":d=new THREE.TetrahedronGeometry(2,2);break;case"DistanceConstraint":d=new THREE.CircleGeometry(2,8);break;case"LockConstraint":d=new THREE.BoxGeometry(2,2,2)}if(a.inverted){for(var g=0;g<d.faces.length;g++){var h=d.faces[g],i=h.a;h.a=h.c,h.c=i}d.computeFaceNormals(),d.computeVertexNormals();for(var j=d.faceVertexUvs[0],g=0;g<j.length;g++){var i=j[g][0];j[g][0]=j[g][2],j[g][2]=i}}return d},THREE.PixelBoxScene.prototype.linkObjects=function(a,b,c){for(var d=function(a){return function(b,c){if("string"==typeof b)return b=b.split("."),b.length?d(b,c):a;if(b.length){var e=b[0];b.splice(0,1);var f=null;if("$"==e.substr(0,1)&&(c.anchors?f=c.anchors[e.substr(1)]:e=e.substr(1)),!f)for(var g=c.children.length-1;g>=0;g--)if(c.children[g].name==e){f=c.children[g];break}return f?b.length?d(b,f):f:null}return null}}(b),e=0,f=a.length;f>e;e++){var g,h,i=a[e],j=i.nearestTemplate();if(this.updateMaterials=this.updateLights=this.updateLights||i instanceof THREE.Light,(i instanceof THREE.SpotLight||i instanceof THREE.DirectionalLight||i.constraint)&&(g=i.def.target,"string"==typeof g&&"#"==g.substr(0,1)&&(h=d(g.substr(1),j?j:b),h&&(i.target=h,i.def.target=!0))),i.def.props&&!c)for(var k in i.def.props)g=i.def.props[k],"string"==typeof g&&"#"==g.substr(0,1)?(void 0===j&&(j=i.nearestTemplate()),h=d(g.substr(1),j?j:b),h&&(i[k]=h)):i[k]=g;this.world&&i.physics&&i.body&&this.CANNON_addConstraints(i,d,j?j:b)}this.world&&"CANNON"===this.physics&&this.CANNON_linkMaterials()},THREE.PixelBoxScene.prototype.CANNON_initObjectPhysics=function(a,b){var c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Euler,h=Math.PI/180;a.matrixWorld.decompose(c,d,e);var i="1"==a.def.bodyType?CANNON.Body.STATIC:"2"==a.def.bodyType?CANNON.Body.KINEMATIC:CANNON.Body.DYNAMIC,j={position:new CANNON.Vec3(c.x,c.y,c.z),quaternion:new CANNON.Quaternion(d.x,d.y,d.z,d.w),velocity:new CANNON.Vec3,angularVelocity:new CANNON.Vec3,mass:i==CANNON.Body.DYNAMIC&&a.def.mass?a.def.mass:0,type:i,linearDamping:a.def.linearDamping?a.def.linearDamping:0};void 0!=a.def.velocity&&j.velocity.set(a.def.velocity[0],a.def.velocity[1],a.def.velocity[2]),void 0!=a.def.angularVelocity&&j.angularVelocity.set(a.def.angularVelocity[0],a.def.angularVelocity[1],a.def.angularVelocity[2]);var k=new CANNON.Body(j);k.collisionFilterGroup=a.def.collisionGroup,k.collisionFilterMask=a.def.collisionMask,k.collisionResponse=!a.def.sensor,k.fixedRotation=!!a.def.fixedRotation,k.constraints=[],k.sleepSpeedLimit=1,k.sleepTimeLimit=.5;var l="M_"+a.def.friction+"_"+a.def.restitution,m=this.world.allMaterials[l];m||(this.world.allMaterials[l]=m=new CANNON.Material(l),m.friction=a.def.friction,m.restitution=a.def.restitution),k.material=m;for(var n=0,o=0,p=b.layers.length;p>o;o++){var q=b.layers[o];if(q.collisionShape){n++,q.position?c.set(q.position[0],q.position[1],q.position[2]):c.set(0,0,0),q.scale?"number"==typeof q.scale?f.set(q.scale,q.scale,q.scale):f.set(q.scale[0],q.scale[1],q.scale[2]):f.set(1,1,1),f.multiply(e),q.rotation?(g.set(q.rotation[0]*h,q.rotation[1]*h,q.rotation[2]*h),d.setFromEuler(g)):d.set(0,0,0,1);var r=null;switch(q.mesh){case"Plane":r=new CANNON.Plane;break;case"Box":r=new CANNON.Box(new CANNON.Vec3(.5*q.width*f.x,.5*q.height*f.y,.5*q.depth*f.z));break;case"Sphere":var s=Math.max(f.x,f.y,f.z);r=new CANNON.Sphere(q.radius*s);break;case"Cylinder":var t=Math.max(f.x,f.z);r=new CANNON.Cylinder(q.radiusTop*t,q.radiusBottom*t,q.height*f.y,q.radiusSegments);var u=new THREE.Quaternion;u.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*-Math.PI),d.multiply(u);break;case"Particle":r=new CANNON.Particle}r&&(c.multiply(e),k.addShape(r,new CANNON.Vec3(c.x,c.y,c.z),new CANNON.Quaternion(d.x,d.y,d.z,d.w)))}}a.body=k,k.obj3d=a},THREE.PixelBoxScene.prototype.CANNON_tick=function(a){this.world.step(Math.min(a,.1));for(var b=new THREE.Matrix4,c=new THREE.Vector3,d=this.world.bodies.length-1;d>=0;d--){var e=this.world.bodies[d];if(e.obj3d){var f=e.obj3d,g=f.parent;g&&g!=this?f.matrix.getInverse(g.matrixWorld):f.matrix.identity(),c.setFromMatrixScale(f.matrixWorld),b.compose(e.position,e.quaternion,c),f.matrix.multiply(b),f.matrix.decompose(f.position,f.quaternion,f.scale),f.rotation.setFromQuaternion(f.quaternion)}}},THREE.PixelBoxScene.prototype.CANNON_addConstraints=function(a,b,c){function d(a){var b=new THREE.Vector3(1,1,1);return _.isArray(a.scale)?b.fromArray(a.scale):b.set(a.scale,a.scale,a.scale),b}var e=a.isDescendantOf(this),f=a.def.layers.concat();e&&this.world.bodies.indexOf(a.body)<0&&(this.world.addBody(a.body),a.def&&a.def.sleep&&a.body.sleep(),a.body.hasEventListener("collide",this.world.collideEventDispatch)||a.body.addEventListener("collide",this.world.collideEventDispatch));var g=null;if(a.parent&&(a.parent.physics&&a.parent.body?g=a.parent:a.parent.isAnchor&&a.parent.parent.physics&&a.parent.parent.body&&(g=a.parent.parent),g))for(var h=0;h<g.body.constraints.length;h++)if(g.body.constraints[h].bodyB==a.body){g=null;break}for(var i=!1,h=0,j=f.length;j>h;h++){h>=j-1&&g&&!i&&(f.push({asset:"Geometry",mesh:"LockConstraint",constraint:!0,name:"parent",isParentConstraint:!0,target:g}),j=f.length);var k=f[h];if(k.constraint&&k.target&&(!k.isParentConstraint||!i)){var l=null,m="string"==typeof k.target?b(k.target.substr(1),c):k.target;if(m&&m.body){m==g&&(i=!0);var n=new THREE.Matrix4,o=new THREE.Vector3,p=new THREE.Vector3(1,1,1),q=new THREE.Quaternion,r=new THREE.Euler,s=Math.PI/180;void 0!=k.position&&o.fromArray(k.position),void 0!=k.scale&&(p=d(k)),void 0!=k.rotation&&r.set(k.rotation[0]*s,k.rotation[1]*s,k.rotation[2]*s),q.setFromEuler(r),n.compose(o,q,p),n.multiplyMatrices(a.matrixWorld,n),n.decompose(o,q,p);var t=a.worldToLocal(o.clone());t.multiply(a.scale);var u=o.clone(),v=m.worldToLocal(o.clone());v.multiply(m.scale);var w=m.localToWorld(new THREE.Vector3);switch(k.mesh){case"PointToPointConstraint":l=new CANNON.PointToPointConstraint(a.body,(new CANNON.Vec3).copy(t),m.body,(new CANNON.Vec3).copy(v),1/0);break;case"DistanceConstraint":var x=w.distanceTo(u);l=new CANNON.DistanceConstraint(a.body,m.body,x);break;case"LockConstraint":l=new CANNON.LockConstraint(a.body,m.body);break;case"HingeConstraint":var y=new THREE.Vector3(0,1,0).applyQuaternion(q),z=new THREE.Matrix4;z.getInverse(m.matrixWorld),z.multiply(n),z.decompose(o,q,p);var A=new THREE.Vector3(0,1,0).applyQuaternion(q);l=new CANNON.HingeConstraint(a.body,m.body,{pivotA:(new CANNON.Vec3).copy(t),pivotB:(new CANNON.Vec3).copy(v),axisA:(new CANNON.Vec3).copy(y),axisB:(new CANNON.Vec3).copy(A),maxForce:1/0}),k.motorTargetVelocity&&(l.enableMotor(),l.motorTargetVelocity=k.motorTargetVelocity*s)}l&&(l.name=k.name,l.collideConnected=!!k.collideConnected,m.body.constraints.push(l),a.body.constraints.push(l),e&&this.world.addConstraint(l))}else console.log(m?"Target for "+k.mesh+" constraint on "+a.name+" doesn't have physics.":"Couldn't find target for "+k.mesh+" constraint on "+a.name)}}},THREE.PixelBoxScene.prototype.CANNON_linkMaterials=function(){for(var a in this.world.allMaterials){var b=this.world.allMaterials[a];for(var c in this.world.allMaterials){var d=this.world.allMaterials[c],e=this.world.getContactMaterial(b,d);e||(e=new CANNON.ContactMaterial(b,d),e.friction=b.friction*d.friction,e.restitution=Math.max(b.restitution,d.restitution),this.world.addContactMaterial(e))}}},THREE.PixelBoxScene.prototype.CANNON_dispatchObjectsCollision=function(a){var b=a.body.obj3d,c=(a.contact.bi==a.body?a.contact.bj:a.contact.bi).obj3d;b.onCollideStart&&b.onCollideStart.call(b,c,a.contact)},THREE.PixelBoxScene.prototype.initObjectPhysics=function(a,b){a.physics=!0,a.def.velocity=b.velocity?b.velocity.concat():[0,0,0],a.def.angularVelocity=b.angularVelocity?b.angularVelocity.concat():[0,0,0],a.def.collisionGroup=void 0!==b.collisionGroup?b.collisionGroup:1,a.def.collisionMask=void 0!==b.collisionMask?b.collisionMask:1,a.def.friction=void 0!==b.friction?b.friction:.3,a.def.restitution=void 0!==b.restitution?b.restitution:.3,a.def.sensor=void 0!==b.sensor?b.sensor:!1,a.def.sleep=void 0!==b.sleep?b.sleep:!1,this.world&&b.layers&&(this.CANNON_initObjectPhysics(a,b),void 0===a.onCollideStart&&(a.onCollideStart=null),void 0===a.onCollideEnd&&(a.onCollideEnd=null))},THREE.PixelBoxScene.prototype.objectRemovedFromWorld=function(a){a.target.removeBodyAndConstraintsFromWorld(this.world)},THREE.PixelBoxScene.prototype.objectAddedToWorld=function(a){for(var b=a.target.parent;b;){if(b===this)return void a.target.addBodyAndConstraintsToWorld(this.world);b=b.parent}},THREE.PixelBoxScene.prototype.dispose=function(a){this.recycle(this.children.concat());for(var b in this.objectPool){for(var c=this.objectPool[b],d=0,e=c.length;e>d;d++){var f=c[d];f.dispose&&f.dispose()}delete this.objectPool[b]}if(a)for(var g in assets.files){var h=assets.files[g];h.frameData&&h.includedWithScene==this&&(THREE.PixelBoxUtil.dispose(h),delete assets.files[g])}},THREE.PixelBoxScene.prototype.render=function(a,b){if(this.world&&this.CANNON_tick(a),this.tick(a),this.placeHolderLights){for(var c=0;c<this.placeHolderLights.length;c++)this.remove(this.placeHolderLights[c]);this.recycle(this.placeHolderLights),this.placeHolderLights=null,this.updateLights=!0}(this.updateLights||this.updateMaterials)&&(THREE.PixelBoxUtil.updateLights(this,this.updateMaterials),this.updateLights=!1,this.updateMaterials=!1),renderer.webgl.setClearColor(this.clearColor,1),this.screenPass?(this.screenPass.renderToScreen=!b,this.composer.render(a)):b?renderer.webgl.render(this,this.camera,this.fbo,!0):renderer.webgl.render(this,this.camera)},THREE.PixelBoxScene.prototype.onCameraChanged=function(a){this.screenPass&&this.composer&&this.composer.renderPass&&(this.composer.renderPass.camera=a)},THREE.PixelBoxScene.prototype.onResized=function(a){if(this.camera instanceof THREE.OrthographicCamera?(this.camera.left=renderer.webgl.domElement.width*-.5,this.camera.right=.5*renderer.webgl.domElement.width,this.camera.top=.5*renderer.webgl.domElement.height,this.camera.bottom=window.innerHeight*-.5,camera.updateProjectionMatrix()):(this.camera.aspect=renderer.webgl.domElement.width/renderer.webgl.domElement.height,this.camera.updateProjectionMatrix()),a){var b={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat,stencilBuffer:!1};this.fbo.dispose(),this.fbo=new THREE.WebGLRenderTarget(renderer.webgl.domElement.width,renderer.webgl.domElement.height,b),this.screenPass&&(this.screenPass.onResized(),this.composer.renderTarget2.dispose(),this.composer.reset(this.fbo))}},function(){var a=this,b=a._,c=Array.prototype,d=Object.prototype,e=Function.prototype,f=c.push,g=c.slice,h=c.concat,i=d.toString,j=d.hasOwnProperty,k=Array.isArray,l=Object.keys,m=e.bind,n=function(a){return a instanceof n?a:this instanceof n?void(this._wrapped=a):new n(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=n),exports._=n):a._=n,n.VERSION="1.7.0";var o=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return function(){return a.apply(b,arguments)}};n.iteratee=function(a,b,c){return null==a?n.identity:n.isFunction(a)?o(a,b,c):n.isObject(a)?n.matches(a):n.property(a)},n.each=n.forEach=function(a,b,c){if(null==a)return a;b=o(b,c);var d,e=a.length;if(e===+e)for(d=0;e>d;d++)b(a[d],d,a);else{var f=n.keys(a);for(d=0,e=f.length;e>d;d++)b(a[f[d]],f[d],a)}return a},n.map=n.collect=function(a,b,c){if(null==a)return[];b=n.iteratee(b,c);for(var d,e=a.length!==+a.length&&n.keys(a),f=(e||a).length,g=Array(f),h=0;f>h;h++)d=e?e[h]:h,g[h]=b(a[d],d,a);return g};var p="Reduce of empty array with no initial value";n.reduce=n.foldl=n.inject=function(a,b,c,d){null==a&&(a=[]),b=o(b,d,4);var e,f=a.length!==+a.length&&n.keys(a),g=(f||a).length,h=0;if(arguments.length<3){if(!g)throw new TypeError(p);c=a[f?f[h++]:h++]}for(;g>h;h++)e=f?f[h]:h,c=b(c,a[e],e,a);return c},n.reduceRight=n.foldr=function(a,b,c,d){null==a&&(a=[]),b=o(b,d,4);var e,f=a.length!==+a.length&&n.keys(a),g=(f||a).length;if(arguments.length<3){if(!g)throw new TypeError(p);c=a[f?f[--g]:--g]}for(;g--;)e=f?f[g]:g,c=b(c,a[e],e,a);return c},n.find=n.detect=function(a,b,c){var d;return b=n.iteratee(b,c),n.some(a,function(a,c,e){return b(a,c,e)?(d=a,!0):void 0}),d},n.filter=n.select=function(a,b,c){var d=[];return null==a?d:(b=n.iteratee(b,c),n.each(a,function(a,c,e){b(a,c,e)&&d.push(a)}),d)},n.reject=function(a,b,c){return n.filter(a,n.negate(n.iteratee(b)),c)},n.every=n.all=function(a,b,c){if(null==a)return!0;b=n.iteratee(b,c);var d,e,f=a.length!==+a.length&&n.keys(a),g=(f||a).length;for(d=0;g>d;d++)if(e=f?f[d]:d,!b(a[e],e,a))return!1;return!0},n.some=n.any=function(a,b,c){if(null==a)return!1;b=n.iteratee(b,c);var d,e,f=a.length!==+a.length&&n.keys(a),g=(f||a).length;for(d=0;g>d;d++)if(e=f?f[d]:d,b(a[e],e,a))return!0;return!1},n.contains=n.include=function(a,b){return null==a?!1:(a.length!==+a.length&&(a=n.values(a)),n.indexOf(a,b)>=0)},n.invoke=function(a,b){var c=g.call(arguments,2),d=n.isFunction(b);return n.map(a,function(a){return(d?b:a[b]).apply(a,c)})},n.pluck=function(a,b){return n.map(a,n.property(b))},n.where=function(a,b){return n.filter(a,n.matches(b))},n.findWhere=function(a,b){return n.find(a,n.matches(b))},n.max=function(a,b,c){var d,e,f=-1/0,g=-1/0;if(null==b&&null!=a){a=a.length===+a.length?a:n.values(a);for(var h=0,i=a.length;i>h;h++)d=a[h],d>f&&(f=d)}else b=n.iteratee(b,c),n.each(a,function(a,c,d){e=b(a,c,d),(e>g||e===-1/0&&f===-1/0)&&(f=a,g=e)});return f},n.min=function(a,b,c){var d,e,f=1/0,g=1/0;if(null==b&&null!=a){a=a.length===+a.length?a:n.values(a);for(var h=0,i=a.length;i>h;h++)d=a[h],f>d&&(f=d)}else b=n.iteratee(b,c),n.each(a,function(a,c,d){e=b(a,c,d),(g>e||1/0===e&&1/0===f)&&(f=a,g=e)});return f},n.shuffle=function(a){for(var b,c=a&&a.length===+a.length?a:n.values(a),d=c.length,e=Array(d),f=0;d>f;f++)b=n.random(0,f),b!==f&&(e[f]=e[b]),e[b]=c[f];return e},n.sample=function(a,b,c){return null==b||c?(a.length!==+a.length&&(a=n.values(a)),a[n.random(a.length-1)]):n.shuffle(a).slice(0,Math.max(0,b))},n.sortBy=function(a,b,c){return b=n.iteratee(b,c),n.pluck(n.map(a,function(a,c,d){return{value:a,index:c,criteria:b(a,c,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")};var q=function(a){return function(b,c,d){var e={};return c=n.iteratee(c,d),n.each(b,function(d,f){var g=c(d,f,b);a(e,d,g)}),e}};n.groupBy=q(function(a,b,c){n.has(a,c)?a[c].push(b):a[c]=[b]}),n.indexBy=q(function(a,b,c){a[c]=b}),n.countBy=q(function(a,b,c){n.has(a,c)?a[c]++:a[c]=1}),n.sortedIndex=function(a,b,c,d){c=n.iteratee(c,d,1);for(var e=c(b),f=0,g=a.length;g>f;){var h=f+g>>>1;c(a[h])<e?f=h+1:g=h}return f},n.toArray=function(a){return a?n.isArray(a)?g.call(a):a.length===+a.length?n.map(a,n.identity):n.values(a):[]},n.size=function(a){return null==a?0:a.length===+a.length?a.length:n.keys(a).length},n.partition=function(a,b,c){b=n.iteratee(b,c);var d=[],e=[];return n.each(a,function(a,c,f){(b(a,c,f)?d:e).push(a)}),[d,e]},n.first=n.head=n.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:0>b?[]:g.call(a,0,b)},n.initial=function(a,b,c){return g.call(a,0,Math.max(0,a.length-(null==b||c?1:b)))},n.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:g.call(a,Math.max(a.length-b,0))},n.rest=n.tail=n.drop=function(a,b,c){return g.call(a,null==b||c?1:b)},n.compact=function(a){return n.filter(a,n.identity)};var r=function(a,b,c,d){if(b&&n.every(a,n.isArray))return h.apply(d,a);for(var e=0,g=a.length;g>e;e++){var i=a[e];n.isArray(i)||n.isArguments(i)?b?f.apply(d,i):r(i,b,c,d):c||d.push(i)}return d};n.flatten=function(a,b){return r(a,b,!1,[])},n.without=function(a){return n.difference(a,g.call(arguments,1))},n.uniq=n.unique=function(a,b,c,d){if(null==a)return[];n.isBoolean(b)||(d=c,c=b,b=!1),null!=c&&(c=n.iteratee(c,d));for(var e=[],f=[],g=0,h=a.length;h>g;g++){var i=a[g];if(b)g&&f===i||e.push(i),f=i;else if(c){var j=c(i,g,a);n.indexOf(f,j)<0&&(f.push(j),e.push(i))}else n.indexOf(e,i)<0&&e.push(i)}return e},n.union=function(){return n.uniq(r(arguments,!0,!0,[]))},n.intersection=function(a){if(null==a)return[];for(var b=[],c=arguments.length,d=0,e=a.length;e>d;d++){var f=a[d];if(!n.contains(b,f)){for(var g=1;c>g&&n.contains(arguments[g],f);g++);g===c&&b.push(f)}}return b},n.difference=function(a){var b=r(g.call(arguments,1),!0,!0,[]);return n.filter(a,function(a){return!n.contains(b,a)})},n.zip=function(a){if(null==a)return[];for(var b=n.max(arguments,"length").length,c=Array(b),d=0;b>d;d++)c[d]=n.pluck(arguments,d);return c},n.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},n.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=n.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}for(;e>d;d++)if(a[d]===b)return d;return-1},n.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=a.length;for("number"==typeof c&&(d=0>c?d+c+1:Math.min(d,c+1));--d>=0;)if(a[d]===b)return d;return-1},n.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=c||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=Array(d),f=0;d>f;f++,a+=c)e[f]=a;return e};var s=function(){};n.bind=function(a,b){var c,d;if(m&&a.bind===m)return m.apply(a,g.call(arguments,1));if(!n.isFunction(a))throw new TypeError("Bind must be called on a function");return c=g.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(g.call(arguments)));s.prototype=a.prototype;var e=new s;s.prototype=null;var f=a.apply(e,c.concat(g.call(arguments)));return n.isObject(f)?f:e}},n.partial=function(a){var b=g.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;f>e;e++)d[e]===n&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},n.bindAll=function(a){var b,c,d=arguments.length;if(1>=d)throw new Error("bindAll must be passed function names");for(b=1;d>b;b++)c=arguments[b],a[c]=n.bind(a[c],a);return a},n.memoize=function(a,b){var c=function(d){var e=c.cache,f=b?b.apply(this,arguments):d;return n.has(e,f)||(e[f]=a.apply(this,arguments)),e[f]};return c.cache={},c},n.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},n.defer=function(a){return n.delay.apply(n,[a,1].concat(g.call(arguments,1)))},n.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=c.leading===!1?0:n.now(),g=null,f=a.apply(d,e),g||(d=e=null)};return function(){var j=n.now();h||c.leading!==!1||(h=j);var k=b-(j-h);return d=this,e=arguments,0>=k||k>b?(clearTimeout(g),g=null,h=j,f=a.apply(d,e),g||(d=e=null)):g||c.trailing===!1||(g=setTimeout(i,k)),f}},n.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=n.now()-g;b>j&&j>0?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),d||(f=e=null)))};return function(){f=this,e=arguments,g=n.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},n.wrap=function(a,b){return n.partial(b,a)},n.negate=function(a){return function(){return!a.apply(this,arguments)}},n.compose=function(){var a=arguments,b=a.length-1;return function(){for(var c=b,d=a[b].apply(this,arguments);c--;)d=a[c].call(this,d);return d}},n.after=function(a,b){return function(){return--a<1?b.apply(this,arguments):void 0}},n.before=function(a,b){var c;return function(){return--a>0?c=b.apply(this,arguments):b=null,c}},n.once=n.partial(n.before,2),n.keys=function(a){if(!n.isObject(a))return[];if(l)return l(a);var b=[];for(var c in a)n.has(a,c)&&b.push(c);return b},n.values=function(a){for(var b=n.keys(a),c=b.length,d=Array(c),e=0;c>e;e++)d[e]=a[b[e]];return d},n.pairs=function(a){for(var b=n.keys(a),c=b.length,d=Array(c),e=0;c>e;e++)d[e]=[b[e],a[b[e]]];return d},n.invert=function(a){for(var b={},c=n.keys(a),d=0,e=c.length;e>d;d++)b[a[c[d]]]=c[d];return b},n.functions=n.methods=function(a){var b=[];for(var c in a)n.isFunction(a[c])&&b.push(c);return b.sort()},n.extend=function(a){if(!n.isObject(a))return a;for(var b,c,d=1,e=arguments.length;e>d;d++){b=arguments[d];for(c in b)j.call(b,c)&&(a[c]=b[c])}return a},n.pick=function(a,b,c){var d,e={};if(null==a)return e;if(n.isFunction(b)){b=o(b,c);for(d in a){var f=a[d];b(f,d,a)&&(e[d]=f)}}else{var i=h.apply([],g.call(arguments,1));a=new Object(a);for(var j=0,k=i.length;k>j;j++)d=i[j],d in a&&(e[d]=a[d])}return e},n.omit=function(a,b,c){if(n.isFunction(b))b=n.negate(b);else{var d=n.map(h.apply([],g.call(arguments,1)),String);b=function(a,b){return!n.contains(d,b)}}return n.pick(a,b,c)},n.defaults=function(a){if(!n.isObject(a))return a;for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];for(var e in d)void 0===a[e]&&(a[e]=d[e])}return a},n.clone=function(a){return n.isObject(a)?n.isArray(a)?a.slice():n.extend({},a):a},n.tap=function(a,b){return b(a),a};var t=function(a,b,c,d){if(a===b)return 0!==a||1/a===1/b;if(null==a||null==b)return a===b;a instanceof n&&(a=a._wrapped),b instanceof n&&(b=b._wrapped);var e=i.call(a);if(e!==i.call(b))return!1;switch(e){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!==+a?+b!==+b:0===+a?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]===a)return d[f]===b;var g=a.constructor,h=b.constructor;if(g!==h&&"constructor"in a&&"constructor"in b&&!(n.isFunction(g)&&g instanceof g&&n.isFunction(h)&&h instanceof h))return!1;c.push(a),d.push(b);var j,k;if("[object Array]"===e){if(j=a.length,k=j===b.length)for(;j--&&(k=t(a[j],b[j],c,d)););}else{var l,m=n.keys(a);if(j=m.length,k=n.keys(b).length===j)for(;j--&&(l=m[j],k=n.has(b,l)&&t(a[l],b[l],c,d)););}return c.pop(),d.pop(),k};n.isEqual=function(a,b){return t(a,b,[],[])},n.isEmpty=function(a){if(null==a)return!0;if(n.isArray(a)||n.isString(a)||n.isArguments(a))return 0===a.length;for(var b in a)if(n.has(a,b))return!1;return!0},n.isElement=function(a){return!(!a||1!==a.nodeType)},n.isArray=k||function(a){return"[object Array]"===i.call(a)},n.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},n.each(["Arguments","Function","String","Number","Date","RegExp"],function(a){n["is"+a]=function(b){return i.call(b)==="[object "+a+"]"}}),n.isArguments(arguments)||(n.isArguments=function(a){return n.has(a,"callee")}),"function"!=typeof/./&&(n.isFunction=function(a){return"function"==typeof a||!1}),n.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},n.isNaN=function(a){return n.isNumber(a)&&a!==+a},n.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"===i.call(a)},n.isNull=function(a){return null===a},n.isUndefined=function(a){return void 0===a},n.has=function(a,b){return null!=a&&j.call(a,b)},n.noConflict=function(){return a._=b,this},n.identity=function(a){return a},n.constant=function(a){return function(){return a}},n.noop=function(){},n.property=function(a){return function(b){return b[a]}},n.matches=function(a){var b=n.pairs(a),c=b.length;return function(a){if(null==a)return!c;a=new Object(a);for(var d=0;c>d;d++){var e=b[d],f=e[0];if(e[1]!==a[f]||!(f in a))return!1}return!0}},n.times=function(a,b,c){var d=Array(Math.max(0,a));b=o(b,c,1);for(var e=0;a>e;e++)d[e]=b(e);return d},n.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},n.now=Date.now||function(){return(new Date).getTime()};var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},v=n.invert(u),w=function(a){var b=function(b){return a[b]},c="(?:"+n.keys(a).join("|")+")",d=RegExp(c),e=RegExp(c,"g");return function(a){return a=null==a?"":""+a,d.test(a)?a.replace(e,b):a}};n.escape=w(u),n.unescape=w(v),n.result=function(a,b){if(null==a)return void 0;var c=a[b];return n.isFunction(c)?a[b]():c};var x=0;n.uniqueId=function(a){var b=++x+"";return a?a+b:b},n.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var y=/(.)^/,z={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},A=/\\|'|\r|\n|\u2028|\u2029/g,B=function(a){return"\\"+z[a]};n.template=function(a,b,c){!b&&c&&(b=c),b=n.defaults({},b,n.templateSettings);var d=RegExp([(b.escape||y).source,(b.interpolate||y).source,(b.evaluate||y).source].join("|")+"|$","g"),e=0,f="__p+='";a.replace(d,function(b,c,d,g,h){return f+=a.slice(e,h).replace(A,B),e=h+b.length,c?f+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'":d?f+="'+\n((__t=("+d+"))==null?'':__t)+\n'":g&&(f+="';\n"+g+"\n__p+='"),b}),f+="';\n",b.variable||(f="with(obj||{}){\n"+f+"}\n"),f="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+f+"return __p;\n";try{var g=new Function(b.variable||"obj","_",f)}catch(h){throw h.source=f,h}var i=function(a){return g.call(this,a,n)},j=b.variable||"obj";return i.source="function("+j+"){\n"+f+"}",i},n.chain=function(a){var b=n(a);return b._chain=!0,b};var C=function(a){return this._chain?n(a).chain():a};n.mixin=function(a){n.each(n.functions(a),function(b){var c=n[b]=a[b];n.prototype[b]=function(){var a=[this._wrapped];return f.apply(a,arguments),C.call(this,c.apply(n,a))}})},n.mixin(n),n.each(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=c[a];n.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!==a&&"splice"!==a||0!==c.length||delete c[0],C.call(this,c)}}),n.each(["concat","join","slice"],function(a){var b=c[a];n.prototype[a]=function(){return C.call(this,b.apply(this._wrapped,arguments))}}),n.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return n})}.call(this);var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=LZString.compress(a);j<2*a.length;)j%2==0?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+LZString._keyStr.charAt(e)+LZString._keyStr.charAt(f)+LZString._keyStr.charAt(g)+LZString._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=LZString._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=LZString._keyStr.indexOf(a.charAt(l++)),g=LZString._keyStr.indexOf(a.charAt(l++)),h=LZString._keyStr.indexOf(a.charAt(l++)),i=LZString._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,k%2==0?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return LZString.decompress(j)},compressToUTF16:function(a){if(null==a)return"";var b,c,d,e="",f=0,g=LZString._f;for(a=LZString.compress(a),b=0;b<a.length;b++)switch(c=a.charCodeAt(b),f++){case 0:e+=g((c>>1)+32),d=(1&c)<<14;break;case 1:e+=g(d+(c>>2)+32),d=(3&c)<<13;break;case 2:e+=g(d+(c>>3)+32),d=(7&c)<<12;break;case 3:e+=g(d+(c>>4)+32),d=(15&c)<<11;break;case 4:e+=g(d+(c>>5)+32),d=(31&c)<<10;break;case 5:e+=g(d+(c>>6)+32),d=(63&c)<<9;break;case 6:e+=g(d+(c>>7)+32),d=(127&c)<<8;break;case 7:e+=g(d+(c>>8)+32),d=(255&c)<<7;break;case 8:e+=g(d+(c>>9)+32),d=(511&c)<<6;break;case 9:e+=g(d+(c>>10)+32),d=(1023&c)<<5;break;case 10:e+=g(d+(c>>11)+32),d=(2047&c)<<4;break;case 11:e+=g(d+(c>>12)+32),d=(4095&c)<<3;break;case 12:e+=g(d+(c>>13)+32),d=(8191&c)<<2;break;case 13:e+=g(d+(c>>14)+32),d=(16383&c)<<1;break;case 14:e+=g(d+(c>>15)+32,(32767&c)+32),f=0}return e+g(d+32)},decompressFromUTF16:function(a){if(null==a)return"";for(var b,c,d="",e=0,f=0,g=LZString._f;f<a.length;){switch(c=a.charCodeAt(f)-32,e++){case 0:b=c<<1;break;case 1:d+=g(b|c>>14),b=(16383&c)<<2;break;case 2:d+=g(b|c>>13),b=(8191&c)<<3;break;case 3:d+=g(b|c>>12),b=(4095&c)<<4;break;case 4:d+=g(b|c>>11),b=(2047&c)<<5;break;case 5:d+=g(b|c>>10),b=(1023&c)<<6;break;case 6:d+=g(b|c>>9),b=(511&c)<<7;break;case 7:d+=g(b|c>>8),b=(255&c)<<8;break;case 8:d+=g(b|c>>7),b=(127&c)<<9;break;case 9:d+=g(b|c>>6),b=(63&c)<<10;break;case 10:d+=g(b|c>>5),b=(31&c)<<11;break;case 11:d+=g(b|c>>4),b=(15&c)<<12;break;case 12:d+=g(b|c>>3),b=(7&c)<<13;break;case 13:d+=g(b|c>>2),b=(3&c)<<14;break;case 14:d+=g(b|c>>1),b=(1&c)<<15;break;case 15:d+=g(b|c),e=0}f++}return LZString.decompress(d)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=LZString._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";if(""==a)return null;var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=LZString._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;
j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}};"undefined"!=typeof module&&null!=module&&(module.exports=LZString),Math.easeInOutSine=function(a,b,c,d){return.5*-c*(Math.cos(Math.PI*a/d)-1)+b},Math.easeInSine=function(a,b,c,d){return-c*Math.cos(a/d*Math.PI*.5)+c+b},Math.easeOutSine=function(a,b,c,d){return c*Math.sin(a/d*Math.PI*.5)+b},Math.linearTween=function(a,b,c,d){return c*a/d+b},Math.seededRandom=function(a){var b=1e4*Math.sin(a+1);return b-Math.floor(b)},THREE.Object3D.prototype.nearestParentWithProperty=function(a,b){return this.parent?!this.parent[a]||void 0!==b&&this.parent[a]!==b?this.parent.nearestParentWithProperty(a,b):this.parent:null},THREE.Object3D.prototype.nearestParentWithoutProperty=function(a){return this.parent?void 0===this.parent[a]?this.parent:this.parent.nearestParentWithoutProperty(a):null},THREE.Object3D.prototype.isVisibleRecursive=function(){return this.visible?this.parent?this.parent.isVisibleRecursive():this.visible:!1},THREE.Object3D.prototype.isDescendantOf=function(a){if(!this.parent)return!1;if(_.isArray(a)){for(var b=0,c=a.length;c>b;b++){var d=a[b];if(this.parent==d)return!0;var e=this.parent.isDescendantOf(d);if(e)return!0}return!1}return this.parent==a?!0:this.parent.isDescendantOf(a)},THREE.Object3D.prototype.parentInstance=function(){return this.isInstance?this:this.parent?this.parent.parentInstance():null},THREE.Object3D.prototype.nearestTemplate=function(){return this.isTemplate?this:this.nearestParentWithProperty("isTemplate",!0)},THREE.Object3D.prototype.recursiveRemoveChildren=function(a){for(var b=[],c=this.children.length-1;c>=0;c--){var d=this.children[c];a&&-1!==a.indexOf(d)||(b=b.concat(d.recursiveRemoveChildren(a)),d.stopTweens&&d.stopTweens(),d.stopAnim&&d.stopAnim(),d.name&&(d.anchored&&this.parent[d.name]&&this.parent[d.name]==d?delete this.parent[d.name]:this[d.name]==d&&delete this[d.name]),d.isAnchor||(this.remove(d),b.push(d)))}return b},THREE.Object3D.prototype.getObjectByUUID=function(a,b){if(this.uuid===a)return this;for(var c=0,d=this.children.length;d>c;c++){var e=this.children[c],f=e.getObjectByUUID(a,b);if(void 0!==f)return f}return void 0},THREE.Object3D.prototype.removeFromParent=function(){return this.parent?(this.parent.remove(this),!0):!1},THREE.Object3D.prototype.lookAtObject=function(a){var b=a.parent?a.parent.localToWorld(a.position.clone()):a.position.clone();this.lookAt(this.parent?this.parent.worldToLocal(b):b)},THREE.Object3D.prototype.transplant=function(a){if(a.isDescendantOf(this))return void console.error("Can't transplant this object to its descendant.");this.matrix.copy(this.matrixWorld),this.matrix.decompose(this.position,this.quaternion,this.scale),this.rotation.setFromQuaternion(this.quaternion);var b=new THREE.Matrix4;b.getInverse(a.matrixWorld),b.multiply(this.matrix),this.matrix.copy(b),this.matrix.decompose(this.position,this.quaternion,this.scale),this.rotation.setFromQuaternion(this.quaternion),a.add(this)},THREE.Object3D.prototype.applyTween=function(a){a.target instanceof THREE.Color?(a.target.r=a.easing(a.time,a.from.r,a.to.r-a.from.r,a.duration),a.target.g=a.easing(a.time,a.from.g,a.to.g-a.from.g,a.duration),a.target.b=a.easing(a.time,a.from.b,a.to.b-a.from.b,a.duration)):a.target instanceof THREE.Vector3?a.target.set(a.easing(a.time,a.from.x,a.to.x-a.from.x,a.duration),a.easing(a.time,a.from.y,a.to.y-a.from.y,a.duration),a.easing(a.time,a.from.z,a.to.z-a.from.z,a.duration)):a.target instanceof THREE.Euler?a.target.set(a.easing(a.time,a.from.x,a.to.x-a.from.x,a.duration),a.easing(a.time,a.from.y,a.to.y-a.from.y,a.duration),a.easing(a.time,a.from.z,a.to.z-a.from.z,a.duration),"XYZ"):a.prop&&(a.target[a.prop]=a.easing(a.time,a.from,a.to-a.from,a.duration))},THREE.Object3D.prototype.advanceTweenFrame=function(){var a=1/60,b=!0;if(!renderer.paused){this._tweenInterval=0;for(var c=this._tweens.length-1;c>=0;c--){var d=this._tweens[c];if(d.time=Math.min(d.time+a,d.duration),this.applyTween(d),d.time>=d.duration)if(d.numLoops>0){if(d.numLoops--,d.autoReverse){var e=d.to;d.to=d.from,d.from=e}void 0!==d.loop&&d.loop.call(this,d),d.time=0}else void 0!==d.done&&d.done.call(this,d),this._tweens.splice(c,1)}b=this._tweens.length>0}b?(this._tweenInterval=!0,renderer.tweenQueue.enqueue(this.advanceTweenFrame,a)):this._tweenInterval=!1},THREE.Object3D.prototype.tween=function(a){var b;b=_.isArray(a)?a:[a],this.hasOwnProperty("advanceTweenFrame")||(this._tweens=[],this.advanceTweenFrame=this.advanceTweenFrame.bind(this));for(var c=b.length-1;c>=0;c--){var d=b[c];d.time=0,void 0===d.duration&&(d.duration=1),void 0===d.target&&(d.target=this),void 0===d.easing&&(d.easing=Math.linearTween),void 0===d.numLoops&&(d.numLoops=0),void 0===d.from&&(d.from=d.target instanceof THREE.Color||d.target instanceof THREE.Vector3||d.target instanceof THREE.Euler?d.target.clone():d.prop&&d.target[d.prop]?_deepClone(d.target[d.prop]):0),void 0!==d.to||(console.log("tween object 'to' parameter is missing: ",d),b.splice(c,1))}return this._tweens=this._tweens.concat(b),this._tweenInterval=!0,renderer.tweenQueue.enqueue(this.advanceTweenFrame,1/60),b},THREE.Object3D.prototype.stopTweens=function(a,b){if(this._tweens){if(a)for(var c=0,d=this._tweens.length;d>c;c++){var e=this._tweens[c];e.time=e.duration,this.applyTween(e),b&&void 0!==e.done&&e.done.call(this,e)}this._tweens.length=0,delete this._tweens,this._tweens=[],this._tweenInterval=!1,renderer.tweenQueue.cancel(this.advanceTweenFrame)}},THREE.Object3D.prototype.stopTween=function(a,b,c){if(this._tweens){var d=this._tweens.indexOf(a);if(-1!==d){if(b){var e=this._tweens[d];e.time=e.duration,this.applyTween(e),c&&void 0!==e.done&&e.done.call(this,e)}this._tweens.splice(d,1)}this._tweens.length||(this._tweenInterval=!1,renderer.tweenQueue.cancel(this.advanceTweenFrame))}},THREE.Object3D.prototype.addBodyAndConstraintsToWorld=function(a){var b=this.body;if(b){a.bodies.indexOf(b)<0&&a.addBody(b);for(var c=0,d=b.constraints.length;d>c;c++){var e=b.constraints[c];if(a.constraints.indexOf(e)<0){var f=e.bodyA==b?e.bodyB:e.bodyA;f.world&&a.addConstraint(e)}}b.hasEventListener("collide",a.collideEventDispatch)||b.addEventListener("collide",a.collideEventDispatch)}for(var c=0;c<this.children.length;c++)this.children[c].addBodyAndConstraintsToWorld(a)},THREE.Object3D.prototype.removeBodyAndConstraintsFromWorld=function(a){var b=this.body;if(b){a.remove(b),b.removeEventListener("collide",a.collideEventDispatch);for(var c=b.constraints.length-1;c>=0;c--){var d=b.constraints[c],e=d.bodyA==b?d.bodyB:d.bodyA;if(a.removeConstraint(d),e){var f=e.constraints.indexOf(d);f>=0&&e.constraints.splice(f,1)}}b.constraints.length=0,this.body=null;for(var c=0;c<this.children.length;c++)this.children[c].removeBodyAndConstraintsFromWorld(a)}},THREE.Object3D.prototype.syncBody=function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Quaternion;return function(){this.body&&(this.matrixWorldNeedsUpdate=!0,this.updateMatrixWorld(),this.matrixWorld.decompose(a,c,b),this.body.position.set(a.x,a.y,a.z),this.body.quaternion.set(c.x,c.y,c.z,c.w))}}(),THREE.Object3D.prototype.syncToBody=function(){{var a=new THREE.Matrix4,b=(new THREE.Vector3,new THREE.Vector3);new THREE.Quaternion}return function(){this.body&&this.parent&&(this.matrix.getInverse(this.parent.matrixWorld),b.setFromMatrixScale(this.matrixWorld),a.compose(this.body.position,this.body.quaternion,b),this.matrix.multiply(a),this.matrix.decompose(this.position,this.quaternion,this.scale),this.rotation.setFromQuaternion(this.quaternion),this.updateWorldMatrix())}}(),THREE.PixelBoxDepthShader={uniforms:{tintAlpha:{type:"f",value:1},pointSize:{type:"f",value:1}},vertexShader:["attribute vec4 color;","uniform float pointSize;","uniform float tintAlpha;","varying vec4 vColor;","void main() {","	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","	vColor = vec4(color.rgb, color.a * tintAlpha);","	gl_Position = projectionMatrix * mvPosition;","	float pointScaleMult = max(length(vec3(modelMatrix[0][0],modelMatrix[1][0],modelMatrix[2][0] )),","		max(length(vec3(modelMatrix[0][1],modelMatrix[1][1],modelMatrix[2][1] )),","		length(vec3(modelMatrix[0][2],modelMatrix[1][2],modelMatrix[2][2] ))));","	if (projectionMatrix[3][3] == 0.0) {","		float fov = 2.0 * atan(1.0 / projectionMatrix[1][1]);","		gl_PointSize = pointScaleMult * pointSize * 600.0 * fov / pow(gl_Position.w, 1.0 + fov * 0.25);","	} else {","		gl_PointSize = pointScaleMult * pointSize * 6.0;","	} ","}"].join("\n"),fragmentShader:["varying vec4 vColor;","float rand(vec2 co) {","	float a = 12.9898;","	float b = 78.233;","   float c = 43758.5453;","   float dt= dot(co.xy ,vec2(a,b));","   float sn= mod(dt,3.14);","   return fract(sin(sn) * c);","}","vec4 pack_depth( const in float depth ) {","	const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bit_mask = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = mod( depth * bit_shift * vec4( 255 ), vec4( 256 ) ) / vec4( 255 );","	res -= res.xxyz * bit_mask;","	return res;","}","void main() {","	if (vColor.a < 1.0) {","		float a = rand(gl_FragCoord.xy);","		a = 1.0 - step(vColor.a, a);","		if (a == 0.0) discard;","	}","	gl_FragData[ 0 ] = pack_depth(gl_FragCoord.z);","}"].join("\n")},THREE.PixelBoxShader={uniforms:{tintColor:{type:"c",value:new THREE.Color(16777215)},addColor:{type:"c",value:new THREE.Color(0)},tintAlpha:{type:"f",value:1},pointSize:{type:"f",value:1},occlusion:{type:"f",value:1},cullBack:{type:"i",value:1},fogColor:{type:"c",value:new THREE.Color(16777215)},fogNear:{type:"f",value:100},fogFar:{type:"f",value:1e3},stipple:{type:"f",value:0},viewPortScale:{type:"f",value:0},actualHemiLights:{type:"i",value:0},actualPointLights:{type:"i",value:0},actualDirLights:{type:"i",value:0},directionalLightShadowMap:{type:"iv1",value:[]},actualSpotLights:{type:"i",value:0},spotLightShadowMap:{type:"iv1",value:[]}},attributes:{color:{type:"v4",value:null},normal:{type:"v3",value:null},occlude:{type:"f",value:null},position:{type:"v3",value:null}},vertexShader:["attribute vec4 color;","attribute float occlude;","uniform float pointSize;","uniform float viewPortScale;","uniform float tintAlpha;","uniform vec3 tintColor;","uniform vec3 addColor;","uniform vec3 fogColor;","uniform float fogNear;","uniform float fogFar;","uniform vec3 ambientLightColor;","uniform float occlusion;","uniform int actualHemiLights;","uniform int actualDirLights;","uniform int actualPointLights;","uniform int actualSpotLights;","uniform int cullBack;","varying vec4 vColor;","#ifdef USE_SHADOWMAP","	uniform mat4 shadowMatrix[ MAX_SHADOWS ];","	uniform sampler2D shadowMap[ MAX_SHADOWS ];","	uniform vec2 shadowMapSize[ MAX_SHADOWS ];","	uniform float shadowBias[ MAX_SHADOWS ];","	float unpackDepth( const in vec4 rgba_depth ) {","		const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","		float depth = dot( rgba_depth, bit_shift );","		return depth;","	}","	vec3 getShadowColor(int shIndex, vec4 mPosition) {","		float fDepth;","		vec3 shadowColor = vec3( 1.0 );","		vec4 shadowCoord4 = shadowMatrix[ shIndex ] * mPosition;","		vec3 shadowCoord = shadowCoord4.xyz / shadowCoord4.w;","		bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","		bool inFrustum = all( inFrustumVec );","		bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","		bool frustumTest = all( frustumTestVec );","		if ( frustumTest ) {","			vec4 rgbaDepth;","			if (shIndex == 0) {","				rgbaDepth = texture2D( shadowMap[ 0 ], shadowCoord.xy );","			}","#if MAX_SHADOWS >= 2","			else if (shIndex == 1) {","				rgbaDepth = texture2D( shadowMap[ 1 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 3","			else if (shIndex == 2) {","				rgbaDepth = texture2D( shadowMap[ 2 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 4","			else if (shIndex == 3) {","				rgbaDepth = texture2D( shadowMap[ 3 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 5","			else if (shIndex == 4) {","				rgbaDepth = texture2D( shadowMap[ 4 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 6","			else if (shIndex == 5) {","				rgbaDepth = texture2D( shadowMap[ 5 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 7","			else if (shIndex == 6) {","				rgbaDepth = texture2D( shadowMap[ 6 ], shadowCoord.xy );","			}","#endif","#if MAX_SHADOWS >= 8","			else if (shIndex == 7) {","				rgbaDepth = texture2D( shadowMap[ 7 ], shadowCoord.xy );","			}","#endif","			float fDepth = unpackDepth( rgbaDepth );","			shadowCoord.z += shadowBias[ shIndex ];","			if ( fDepth < shadowCoord.z ) {","				shadowColor = vec3(0.0);","			}","		}","		return shadowColor;","	}","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform int directionalLightShadowMap[ MAX_DIR_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform int spotLightShadowMap[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","void main() {","	vec3 diffuse = color.xyz;","	diffuse *= tintColor;","	vec3 totalAmbient = diffuse * ambientLightColor;","	vec3 totalDirect = vec3(0.0);","	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","	vec4 mPosition = modelMatrix * vec4( position, 1.0 );","	float normalLength = length(normal);","	float brightness = normalLength - 1.0;","	vec3 vertexNormal = normalize(normalMatrix * normal);","	if (cullBack != 0 && vertexNormal.z <= -0.5) { ","		vColor = vec4(0.0);","	} else { ","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","	if (i < actualPointLights) {","	vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","	vec3 lVector = lPosition.xyz - mvPosition.xyz;","	float lDistance = 1.0;","	if ( pointLightDistance[ i ] > 0.0 )","		lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","	lVector = normalize( lVector );","	float dotProduct = dot( vertexNormal, lVector );","	if (occlude < 0.0) dotProduct = (1.0 + max(dotProduct, 0.0) + occlude) * 0.5;","	#ifdef WRAP_AROUND","		float pointDiffuseWeightFull = max( dotProduct, 0.0 );","		float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","		vec3 pointDiffuseWeight = mix( vec3( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","	#else","		float pointDiffuseWeight = max( dotProduct, 0.0 );","	#endif","	pointDiffuse += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","	}","}","totalDirect += pointDiffuse;","#endif","	vec3 thisLight;","	int shadowMapIndex;","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","	if (i < actualDirLights) {","	vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","	vec3 dirVector = normalize( lDirection.xyz);","	float dotProduct = dot(vertexNormal, dirVector);","	if (occlude < 0.0) dotProduct = (1.0 + max(dotProduct, 0.0) + occlude) * 0.5;","	#ifdef WRAP_AROUND","		float dirDiffuseWeightFull = max( dotProduct, 0.0 );","		float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","		vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","	#else","		float dirDiffuseWeight = max( dotProduct, 0.0 );","	#endif","	thisLight = diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","#ifdef USE_SHADOWMAP","	shadowMapIndex = directionalLightShadowMap[ i ];","	if (shadowMapIndex != 0) {","		thisLight = thisLight * getShadowColor(shadowMapIndex - 1, mPosition);","	}","#endif","	dirDiffuse += thisLight;","	}","}","totalDirect += dirDiffuse;","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","	if (i < actualSpotLights) {","	vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","	vec3 lVector = lPosition.xyz - mvPosition.xyz;//lPosition.xyz + vViewPosition.xyz;","	float lDistance = 1.0;","	if ( spotLightDistance[ i ] > 0.0 )","		lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","	lVector = normalize( lVector );","	float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - mPosition.xyz ) );","	if ( spotEffect > spotLightAngleCos[ i ] ) {","		spotEffect = max( pow( max( spotEffect, 0.0 ), spotLightExponent[ i ] * 0.25 ), 0.0 );","		float dotProduct = dot( vertexNormal, lVector );","		if (occlude < 0.0) dotProduct = (1.0 + max(dotProduct, 0.0) + occlude) * 0.5;","		#ifdef WRAP_AROUND","			float spotDiffuseWeightFull = max( dotProduct, 0.0 );","			float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","			vec3 spotDiffuseWeight = mix( vec3( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","		#else","			float spotDiffuseWeight = max( dotProduct, 0.0 );","		#endif","		thisLight = diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","#ifdef USE_SHADOWMAP","		shadowMapIndex = spotLightShadowMap[ i ];","		if (shadowMapIndex != 0) {","			thisLight = thisLight * getShadowColor(shadowMapIndex - 1, mPosition);","		}","#endif","		spotDiffuse += thisLight;","	}","	}","}","totalDirect += spotDiffuse;","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","	if (i < actualHemiLights) {","	vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","	vec3 lVector = normalize( lDirection.xyz );","	float dotProduct = dot( vertexNormal, lVector );","	if (occlude < 0.0) dotProduct = (1.0 + max(dotProduct, 0.0) + occlude) * 0.5;","	float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","	vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","	hemiDiffuse += diffuse * hemiColor;","	}","}","totalAmbient += hemiDiffuse;","#endif","totalAmbient = totalAmbient * clamp(1.0 - occlusion * abs(occlude), 0.0, 1.0);","vec3 totalDiffuse = mix(totalAmbient + totalDirect, diffuse, brightness);","	float depth = distance(mvPosition.xyz, cameraPosition);","	vColor = vec4(addColor + mix(totalDiffuse, fogColor, smoothstep( fogNear, fogFar, depth )), color.a * tintAlpha);","	} // end if cullBack ","	gl_Position = projectionMatrix * mvPosition;","	float pointScaleMult = max(length(vec3(modelMatrix[0][0],modelMatrix[1][0],modelMatrix[2][0] )),","		max(length(vec3(modelMatrix[0][1],modelMatrix[1][1],modelMatrix[2][1] )),","		length(vec3(modelMatrix[0][2],modelMatrix[1][2],modelMatrix[2][2] ))));","	gl_PointSize = pointScaleMult * viewPortScale * pointSize / gl_Position.w;","}"].join("\n"),fragmentShader:["varying vec4 vColor;","uniform float stipple;","float rand(vec2 co) {","	float a = 12.9898;","	float b = 78.233;","   float c = 43758.5453;","   float dt= dot(co.xy ,vec2(a,b));","   float sn= mod(dt,3.14);","   return fract(sin(sn) * c);","}","void main() {","	float s = 1.0; ","	if (stipple != 0.0) { ","		vec2 stip = fract( vec2(gl_FragCoord.x + stipple, gl_FragCoord.y) * 0.5);","		s = step(0.25,abs(stip.x-stip.y));","	}","	if (vColor.a == 0.0 || s == 0.0) discard;","	else if (vColor.a < 1.0) {","		float a = rand(gl_FragCoord.xy);","		a = s * (1.0 - step(vColor.a, a));","		if (a == 0.0) discard;","	}","	gl_FragColor = vec4(vColor.rgb, 1.0);","}"].join("\n")},THREE.PixelBoxMeshDepthShader={uniforms:{map:{type:"t",value:null},tintAlpha:{type:"f",value:1},alphaThresh:{type:"f",value:0},uvSliceRect:{type:"v4",value:{x:0,y:1,z:1,w:0}},uvSliceOffset:{type:"v4",value:{x:0,y:1,z:1,w:1}},uvSliceSizeIsRotated:{type:"v3",value:{x:1,y:1,z:0}},parentWorldMatrix:{type:"m4",value:new THREE.Matrix4},localMatrix:{type:"m4",value:new THREE.Matrix4},spriteTransform:{type:"m4",value:new THREE.Matrix4}},vertexShader:["varying vec2 vUv;","uniform mat4 parentWorldMatrix;","uniform mat4 localMatrix;","uniform mat4 spriteTransform;","void main() {","   vec4 mvPosition;","   #ifdef BILLBOARD","       mat4 modelView = viewMatrix * parentWorldMatrix;","	    modelView[0][0] = 1.0;","	    modelView[0][1] = 0.0;","       modelView[0][2] = 0.0;","	    modelView[1][0] = 0.0;","	    modelView[1][1] = 1.0;","   	modelView[1][2] = 0.0;","       modelView[2][0] = 0.0;","       modelView[2][1] = 0.0;","       modelView[2][2] = 1.0;","       modelView = modelView * spriteTransform * localMatrix;","	    mvPosition = modelView * vec4( position, 1.0 );","   #else","	    mvPosition = modelViewMatrix * vec4( position, 1.0 );","   #endif","	vUv = uv;","	gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["varying vec2 vUv;","#ifdef USE_MAP","uniform sampler2D map;","uniform vec4 uvSliceRect;","uniform vec4 uvSliceOffset;","uniform vec3 uvSliceSizeIsRotated;","#endif","uniform float tintAlpha;","uniform float alphaThresh;","#ifdef USE_MAP","vec4 sampleSlice(){","   vec2 _uv;","   #ifdef BILLBOARD","   if (uvSliceSizeIsRotated.z < 1.0) { ","       _uv =  vUv;","       _uv.x = uvSliceOffset.x + ( _uv.x ) * uvSliceOffset.z;","       _uv.y = uvSliceOffset.y - ( 1.0 - _uv.y ) * uvSliceOffset.w;","   } else { ","       _uv = vec2(vUv.y, vUv.x);","       _uv.x = uvSliceOffset.x + ( _uv.x ) * uvSliceOffset.z;","       _uv.y = uvSliceOffset.y - ( _uv.y ) * uvSliceOffset.w;","   }","   #else","   if (uvSliceSizeIsRotated.z < 1.0) { ","       _uv =  vUv;","       if(_uv.x <= uvSliceRect.x || _uv.y <= uvSliceRect.w || _uv.x >= uvSliceRect.z || _uv.y >= uvSliceRect.y) {","           discard;","       }","       _uv.x = uvSliceOffset.x + (_uv.x - uvSliceRect.x) * uvSliceSizeIsRotated.x;","       _uv.y = uvSliceOffset.y + (_uv.y - uvSliceRect.y) * uvSliceSizeIsRotated.y;","   } else { ","       _uv = vec2(vUv.y, 1.0 - vUv.x);","       if(vUv.x <= uvSliceRect.x || vUv.y <= uvSliceRect.w || vUv.x >= uvSliceRect.z || vUv.y >= uvSliceRect.y) {","           discard;","       }","       _uv.x = uvSliceOffset.x + (_uv.x - uvSliceRect.w) * uvSliceSizeIsRotated.y;","       _uv.y = uvSliceOffset.y + (_uv.y - (1.0 - uvSliceRect.x)) * uvSliceSizeIsRotated.x;","   }","   #endif","   return texture2D( map, _uv );","}","#endif","float rand(vec2 co) {","	float a = 12.9898;","	float b = 78.233;","   float c = 43758.5453;","   float dt= dot(co.xy ,vec2(a,b));","   float sn= mod(dt,3.14);","   return fract(sin(sn) * c);","}","vec4 pack_depth( const in float depth ) {","	const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bit_mask = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = mod( depth * bit_shift * vec4( 255 ), vec4( 256 ) ) / vec4( 255 );","	res -= res.xxyz * bit_mask;","	return res;","}","void main() {","   vec4 texColor = vec4(0.0, 0.0, 0.0, 1.0);","#ifdef USE_MAP","   texColor = sampleSlice();","#endif","   texColor.a = texColor.a <= alphaThresh ? 0.0 : (texColor.a * tintAlpha);","	if (texColor.a < 1.0) {","		float a = rand(gl_FragCoord.xy);","		a = 1.0 - step(texColor.a, a);","		if (a == 0.0) discard;","	}","	gl_FragData[ 0 ] = pack_depth(gl_FragCoord.z);","}"].join("\n")},THREE.PixelBoxMeshShader={uniforms:{map:{type:"t",value:null},tintColor:{type:"c",value:new THREE.Color(16777215)},addColor:{type:"c",value:new THREE.Color(0)},tintAlpha:{type:"f",value:1},brightness:{type:"f",value:0},alphaThresh:{type:"f",value:0},fogColor:{type:"c",value:new THREE.Color(16777215)},fogNear:{type:"f",value:100},fogFar:{type:"f",value:1e3},stipple:{type:"f",value:0},actualHemiLights:{type:"i",value:0},actualPointLights:{type:"i",value:0},actualDirLights:{type:"i",value:0},directionalLightShadowMap:{type:"iv1",value:[]},actualSpotLights:{type:"i",value:0},spotLightShadowMap:{type:"iv1",value:[]},uvSliceRect:{type:"v4",value:{x:0,y:1,z:1,w:0}},uvSliceOffset:{type:"v4",value:{x:0,y:1,z:1,w:1}},uvSliceSizeIsRotated:{type:"v3",value:{x:1,y:1,z:0}},billboard:{type:"i",value:0},parentWorldMatrix:{type:"m4",value:new THREE.Matrix4},localMatrix:{type:"m4",value:new THREE.Matrix4},spriteTransform:{type:"m4",value:new THREE.Matrix4}},attributes:{},vertexShader:["varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec4 vWorldPosition;","varying vec2 vUv;","uniform mat4 parentWorldMatrix;","uniform mat4 localMatrix;","uniform mat4 spriteTransform;","void main() {","#ifdef FLIP_SIDED","	vNormal = normalize( normalMatrix * (-normal) );","#else","	vNormal = normalize( normalMatrix * normal );","#endif","   vec4 mvPosition;","   #ifdef BILLBOARD","       mat4 modelView = viewMatrix * parentWorldMatrix;","	    modelView[0][0] = 1.0;","	    modelView[0][1] = 0.0;","       modelView[0][2] = 0.0;","	    modelView[1][0] = 0.0;","	    modelView[1][1] = 1.0;","   	modelView[1][2] = 0.0;","       modelView[2][0] = 0.0;","       modelView[2][1] = 0.0;","       modelView[2][2] = 1.0;","       modelView = modelView * spriteTransform * localMatrix;","	    mvPosition = modelView * vec4( position, 1.0 );","   #else","	    mvPosition = modelViewMatrix * vec4( position, 1.0 );","   #endif","	vViewPosition = -mvPosition.xyz;","	vWorldPosition = modelMatrix * vec4( position, 1.0 );","   vUv = uv; ","	gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["varying vec2 vUv;","#ifdef USE_MAP","uniform sampler2D map;","uniform vec4 uvSliceRect;","uniform vec4 uvSliceOffset;","uniform vec3 uvSliceSizeIsRotated;","#endif","uniform vec3 tintColor;","uniform vec3 addColor;","uniform float tintAlpha;","uniform float alphaThresh;","uniform float stipple;","uniform float brightness;","uniform vec3 ambientLightColor;","uniform int actualHemiLights;","uniform int actualDirLights;","uniform int actualPointLights;","uniform int actualSpotLights;","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec4 vWorldPosition;","uniform vec3 fogColor;","uniform float fogNear;","uniform float fogFar;","#ifdef USE_SHADOWMAP","	uniform mat4 shadowMatrix[ MAX_SHADOWS ];","	uniform sampler2D shadowMap[ MAX_SHADOWS ];","	uniform vec2 shadowMapSize[ MAX_SHADOWS ];","	uniform float shadowBias[ MAX_SHADOWS ];","	float unpackDepth( const in vec4 rgba_depth ) {","		const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","		float depth = dot( rgba_depth, bit_shift );","		return depth;","	}","	vec3 getShadowColor(int shadowIndex, vec4 mPosition) {","		vec3 shadowColor = vec3(1.0);","		float fDepth;","#ifdef BILLBOARD","   #define SHADOW_THRESH 0.005","#else","   #define SHADOW_THRESH 0.0","#endif","		if (shadowIndex == 0) {","			vec4 sm = shadowMatrix[ 0 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 0 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 0 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		} ","#if MAX_SHADOWS >= 2","		else ","		if (shadowIndex == 1) {","			vec4 sm = shadowMatrix[ 1 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 1 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 1 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		} ","#endif","#if MAX_SHADOWS >= 3","		else ","		if (shadowIndex == 2) {","			vec4 sm = shadowMatrix[ 2 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 2 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 2 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		} ","#endif","#if MAX_SHADOWS >= 4","		else ","		if (shadowIndex == 3) {","			vec4 sm = shadowMatrix[ 3 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 3 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 3 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		}","#endif","#if MAX_SHADOWS >= 5","		else ","		if (shadowIndex == 4) {","			vec4 sm = shadowMatrix[ 4 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 4 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 4 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		}","#endif","#if MAX_SHADOWS >= 6","		else ","		if (shadowIndex == 5) {","			vec4 sm = shadowMatrix[ 5 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 5 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 5 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		}","#endif","#if MAX_SHADOWS >= 7","		else ","		if (shadowIndex == 6) {","			vec4 sm = shadowMatrix[ 6 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 6 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 6 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		}","#endif","#if MAX_SHADOWS >= 8","		else ","		if (shadowIndex == 7) {","			vec4 sm = shadowMatrix[ 7 ] * mPosition;","			vec3 shadowCoord = sm.xyz / sm.w;","			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","			bool inFrustum = all( inFrustumVec );","			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","			bool frustumTest = all( frustumTestVec );","			if ( frustumTest ) {","				shadowCoord.z += shadowBias[ 7 ];","				float fDepth = unpackDepth( texture2D( shadowMap[ 7 ], shadowCoord.xy ) );","				if ( shadowCoord.z - fDepth > SHADOW_THRESH ) {","					shadowColor = vec3(0.0);","				}","			}","		}","#endif","		return shadowColor;","	}","#endif","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","uniform int directionalLightShadowMap[ MAX_DIR_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform int spotLightShadowMap[ MAX_SPOT_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","float rand(vec2 co) {","	float a = 12.9898;","	float b = 78.233;","   float c = 43758.5453;","   float dt = dot(co.xy ,vec2(a,b));","   float sn = mod(dt,3.14);","   return fract(sin(sn) * c);","}","#ifdef USE_MAP","vec4 sampleSlice(){","   vec2 _uv;","   #ifdef BILLBOARD","   if (uvSliceSizeIsRotated.z < 1.0) { ","       _uv =  vUv;","       _uv.x = uvSliceOffset.x + ( _uv.x ) * uvSliceOffset.z;","       _uv.y = uvSliceOffset.y - ( 1.0 - _uv.y ) * uvSliceOffset.w;","   } else { ","       _uv = vec2(vUv.y, vUv.x);","       _uv.x = uvSliceOffset.x + ( _uv.x ) * uvSliceOffset.z;","       _uv.y = uvSliceOffset.y - ( _uv.y ) * uvSliceOffset.w;","   }","   #else","   if (uvSliceSizeIsRotated.z < 1.0) { ","       _uv =  vUv;","       if(_uv.x <= uvSliceRect.x || _uv.y <= uvSliceRect.w || _uv.x >= uvSliceRect.z || _uv.y >= uvSliceRect.y) {","           discard;","       }","       _uv.x = uvSliceOffset.x + (_uv.x - uvSliceRect.x) * uvSliceSizeIsRotated.x;","       _uv.y = uvSliceOffset.y + (_uv.y - uvSliceRect.y) * uvSliceSizeIsRotated.y;","   } else { ","       _uv = vec2(vUv.y, 1.0 - vUv.x);","       if(vUv.x <= uvSliceRect.x || vUv.y <= uvSliceRect.w || vUv.x >= uvSliceRect.z || vUv.y >= uvSliceRect.y) {","           discard;","       }","       _uv.x = uvSliceOffset.x + (_uv.x - uvSliceRect.w) * uvSliceSizeIsRotated.y;","       _uv.y = uvSliceOffset.y + (_uv.y - (1.0 - uvSliceRect.x)) * uvSliceSizeIsRotated.x;","   }","   #endif","   return texture2D( map, _uv );","}","#endif","void main() {","	float s = 1.0; ","   float texAlpha = 1.0;","   vec3 texColor = vec3( 1.0, 1.0, 1.0 );","	if (stipple != 0.0) { ","		vec2 stip = fract( vec2(gl_FragCoord.x + stipple, gl_FragCoord.y) * 0.5);","		s = step(0.25,abs(stip.x-stip.y));","	}","#ifdef USE_MAP","   vec4 tex = sampleSlice();","   texAlpha = tex.a <= alphaThresh ? 0.0 : tex.a;","   texColor = tex.xyz;","#endif","   texAlpha *= tintAlpha;","	if (texAlpha == 0.0 || s == 0.0) discard;","	else if (texAlpha < 1.0) {","		float a = rand(gl_FragCoord.xy);","		a = s * (1.0 - step(texAlpha, a));","		if (a == 0.0) discard;","	}","	vec3 diffuse = tintColor * texColor;","	vec3 totalAmbient = diffuse * ambientLightColor;","	vec3 totalDirect = vec3(0.0);","	vec4 mvPosition = vec4(-vViewPosition.xyz, 1.0 );","	vec4 mPosition = vWorldPosition;","	vec3 vertexNormal = normalize(vNormal);","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","	if (i < actualPointLights) {","	vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","	vec3 lVector = lPosition.xyz - mvPosition.xyz;","	float lDistance = 1.0;","	if ( pointLightDistance[ i ] > 0.0 )","		lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","	lVector = normalize( lVector );","   #ifdef BILLBOARD","   float dotProduct = 1.0;","   #else","	float dotProduct = dot( vertexNormal, lVector );","   #endif","	#ifdef WRAP_AROUND","		float pointDiffuseWeightFull = max( dotProduct, 0.0 );","		float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","		vec3 pointDiffuseWeight = mix( vec3( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","	#else","		float pointDiffuseWeight = max( dotProduct, 0.0 );","	#endif","	pointDiffuse += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","	}","}","totalDirect += pointDiffuse;","#endif","	vec3 thisLight;","	int shadowMapIndex;","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","	if (i < actualDirLights) {","	vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","	vec3 dirVector = normalize( lDirection.xyz);","   #ifdef BILLBOARD","   float dotProduct = 1.0;","   #else","	float dotProduct = dot( vertexNormal, dirVector );","   #endif","	#ifdef WRAP_AROUND","		float dirDiffuseWeightFull = max( dotProduct, 0.0 );","		float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","		vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","	#else","		float dirDiffuseWeight = max( dotProduct, 0.0 );","	#endif","	thisLight = diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","#ifdef USE_SHADOWMAP","	shadowMapIndex = directionalLightShadowMap[ i ];","	if (shadowMapIndex != 0) {","		thisLight = thisLight * getShadowColor(shadowMapIndex - 1, mPosition);","	}","#endif","	dirDiffuse += thisLight;","	}","}","totalDirect += dirDiffuse;","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","	if (i < actualSpotLights) {","	vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","	vec3 lVector = lPosition.xyz - mvPosition.xyz;//lPosition.xyz + vViewPosition.xyz;","	float lDistance = 1.0;","	if ( spotLightDistance[ i ] > 0.0 )","		lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","	lVector = normalize( lVector );","	float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - mPosition.xyz ) );","	if ( spotEffect > spotLightAngleCos[ i ] ) {","		spotEffect = max( pow( max( spotEffect, 0.0 ), spotLightExponent[ i ] ), 0.0 );","       #ifdef BILLBOARD","       float dotProduct = 1.0;","       #else","	    float dotProduct = dot( vertexNormal, lVector );","       #endif","		#ifdef WRAP_AROUND","			float spotDiffuseWeightFull = max( dotProduct, 0.0 );","			float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","			vec3 spotDiffuseWeight = mix( vec3( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","		#else","			float spotDiffuseWeight = max( dotProduct, 0.0 );","		#endif","		thisLight = diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","#ifdef USE_SHADOWMAP","		shadowMapIndex = spotLightShadowMap[ i ];","		if (shadowMapIndex != 0) {","			thisLight = thisLight * getShadowColor(shadowMapIndex - 1, mPosition);","		}","#endif","		spotDiffuse += thisLight;","	}","	}","}","totalDirect += spotDiffuse;","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse = vec3( 0.0 );","for ( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","	if (i < actualHemiLights) {","	vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","	vec3 lVector = normalize( lDirection.xyz );","   #ifdef BILLBOARD","   float dotProduct = 1.0;","   #else","	float dotProduct = dot( vertexNormal, lVector );","   #endif","	float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","	vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","	hemiDiffuse += diffuse * hemiColor;","	}","}","totalAmbient += hemiDiffuse;","#endif","vec3 totalDiffuse = mix(totalAmbient + totalDirect, diffuse, brightness);","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = smoothstep( fogNear, fogFar, depth );","gl_FragColor = vec4(mix(totalDiffuse + addColor, fogColor, fogFactor), 1.0);","}"].join("\n")},THREE.MeshPixelBoxMaterial=function(a){function b(b,c){return a&&void 0!=a[b]?a[b]:c
}var c=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.shadowmap,THREE.UniformsLib.lights,THREE.PixelBoxMeshShader.uniforms]),attributes:THREE.PixelBoxMeshShader.attributes,vertexShader:THREE.PixelBoxMeshShader.vertexShader,fragmentShader:THREE.PixelBoxMeshShader.fragmentShader,defines:b("defines",{}),transparent:!1,lights:!0,fog:!0}),d=c.uniforms;return d.tintColor.value.set(b("tint",16777215)),d.addColor.value.set(b("addColor",0)),d.tintAlpha.value=b("alpha",1),d.brightness.value=b("brightness",0),d.actualHemiLights=THREE.PixelBoxUtil.material.uniforms.actualHemiLights,d.actualDirLights=THREE.PixelBoxUtil.material.uniforms.actualDirLights,d.actualPointLights=THREE.PixelBoxUtil.material.uniforms.actualPointLights,d.actualSpotLights=THREE.PixelBoxUtil.material.uniforms.actualSpotLights,d.directionalLightShadowMap=THREE.PixelBoxUtil.material.uniforms.directionalLightShadowMap,d.spotLightShadowMap=THREE.PixelBoxUtil.material.uniforms.spotLightShadowMap,Object.defineProperty(c,"tint",{get:function(){return this.uniforms.tintColor.value},set:function(a){this.uniforms.tintColor.value.copy(a)}}),Object.defineProperty(c,"addColor",{get:function(){return this.uniforms.addColor.value},set:function(a){this.uniforms.addColor.value.copy(a)}}),Object.defineProperty(c,"alpha",{get:function(){return this.uniforms.tintAlpha.value},set:function(a){this.uniforms.tintAlpha.value=a}}),Object.defineProperty(c,"alphaThresh",{get:function(){return this.uniforms.alphaThresh.value},set:function(a){this.uniforms.alphaThresh.value=a}}),Object.defineProperty(c,"brightness",{get:function(){return this.uniforms.brightness.value},set:function(a){this.uniforms.brightness.value=a}}),Object.defineProperty(c,"stipple",{get:function(){return this.uniforms.stipple.value},set:function(a){this.uniforms.stipple.value=a}}),Object.defineProperty(c,"map",{get:function(){return this.uniforms.map.value},set:function(a){this.uniforms.map.value=a,this.slice=this._slice,this.needsUpdate=!0}}),Object.defineProperty(c,"slice",{get:function(){return this._slice},set:function(a){this._slice=a;var b=this.uniforms;if(a&&b.map.value){var c=this.uniforms.map.value,d=c.image.width,e=c.image.height;b.uvSliceRect.value={x:a.spriteColorRect.x/a.spriteSourceSize.x,y:1-a.spriteColorRect.y/a.spriteSourceSize.y,z:(a.spriteColorRect.x+a.spriteColorRect.width)/a.spriteSourceSize.x,w:1-(a.spriteColorRect.y+a.spriteColorRect.height)/a.spriteSourceSize.y},b.uvSliceOffset.value={x:a.textureRect.x/d,y:1-a.textureRect.y/e,z:a.textureRect.width/d,w:a.textureRect.height/e},b.uvSliceSizeIsRotated.value={x:a.spriteSourceSize.x/d,y:a.spriteSourceSize.y/e,z:a.textureRotated?1:0}}else b.uvSliceRect.value={x:0,y:1,z:1,w:0},b.uvSliceOffset.value={x:0,y:1,z:1,w:1},b.uvSliceSizeIsRotated.value={x:1,y:1,z:0}}}),c},THREE.PixelBox=function(a){function b(b,c){return void 0!=a[b]?a[b]:c}var c=THREE.PixelBoxUtil.material.clone(),d=THREE.PixelBoxUtil.depthMaterial.clone();c.uniforms.viewPortScale=THREE.PixelBoxUtil.material.uniforms.viewPortScale,c.uniforms.actualHemiLights=THREE.PixelBoxUtil.material.uniforms.actualHemiLights,c.uniforms.actualDirLights=THREE.PixelBoxUtil.material.uniforms.actualDirLights,c.uniforms.actualPointLights=THREE.PixelBoxUtil.material.uniforms.actualPointLights,c.uniforms.actualSpotLights=THREE.PixelBoxUtil.material.uniforms.actualSpotLights,c.uniforms.directionalLightShadowMap=THREE.PixelBoxUtil.material.uniforms.directionalLightShadowMap,c.uniforms.spotLightShadowMap=THREE.PixelBoxUtil.material.uniforms.spotLightShadowMap,d.uniforms.viewPortScale=THREE.PixelBoxUtil.material.uniforms.viewPortScale,d.uniforms.tintAlpha=c.uniforms.tintAlpha,d.uniforms.pointSize=c.uniforms.pointSize,c.uniforms.occlusion.value=b("occlusion",1),c.uniforms.pointSize.value=b("pointSize",1),c.uniforms.cullBack.value=b("cullBack",!0);var e=new THREE.BufferGeometry;if(this._pivot=new THREE.Vector3(.5*a.width,.5*a.height,.5*a.depth),e.computeBoundingSphere=function(){null===this.geometry.boundingSphere&&(this.geometry.boundingSphere=new THREE.Sphere),this.geometry.boundingSphere.center.set(.5*this.geometry.data.width-this._pivot.x,.5*this.geometry.data.height-this._pivot.y,.5*this.geometry.data.depth-this._pivot.z),this.geometry.boundingSphere.radius=.5*Math.max(this.geometry.data.width,this.geometry.data.depth,this.geometry.data.height)}.bind(this),e.computeBoundingBox=function(){null===this.geometry.boundingBox&&(this.geometry.boundingBox=new THREE.Box3),this.geometry.boundingBox.min.set(0,0,0),this.geometry.boundingBox.max.set(this.geometry.data.width,this.geometry.data.height,this.geometry.data.depth),this.geometry.boundingBox.translate(this._pivot.clone().multiplyScalar(-1))}.bind(this),THREE.PixelBoxUtil.processPixelBoxFrames(a),THREE.PointCloud.call(this,e,c),this.customDepthMaterial=d,this.castShadow=!0,this.pixelBox=!0,this.anchors={},a.anchors)for(var f in a.anchors)if("PIVOT"!=f){var g=new THREE.Object3D;g.isContainer=!0,g.detached=!1,g.isAnchor=!0,g.name=f,g.visible=!1,this.add(g),this.anchors[f]=g}else this._pivot.set(a.anchors[f][0].x,a.anchors[f][0].y,a.anchors[f][0].z);else a.anchors={};if(e.data=a,e._frame=-1,Object.defineProperty(this,"frame",{get:function(){return this.geometry._frame},set:function(a){var b=this.geometry,c=b.data;if(a!=b._frame&&c.frameData&&c.frameData.length){0>a&&(a=c.frameData.length+a%c.frameData.length),a%=c.frameData.length,b._frame=a;var d=c.frameData[a];if(d.p&&(b.addAttribute("position",d.p),b.addAttribute("color",d.c),b.addAttribute("normal",d.n),b.addAttribute("occlude",d.o),!d.p.buffer)){var e=renderer.webgl.context;for(var f in b.attributes){var g="index"===f?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,h=b.attributes[f];if(!h.buffer){h.buffer=e.createBuffer();{e.bindBuffer(g,h.buffer)}e.bufferData(g,h.array,e.STATIC_DRAW)}}}void 0!=d.s?b.offsets=[{index:d.s,count:d.l}]:d.o&&(b.offsets=[]);var i={type:"frame",frame:a};this.dispatchEvent(i);var j=Math.PI/180;for(var k in this.anchors){var l=this.anchors[k],m=c.anchors[k][a];if(!l.detached&&(l.visible=!!m.on,l.position.set(m.x-this._pivot.x,m.y-this._pivot.y,m.z-this._pivot.z),l.rotation.set(m.rx*j,m.ry*j,m.rz*j),l.scale.set(m.sx||1e-5,m.sy||1e-5,m.sz||1e-5),l.updateMatrixWorld(!0),m.meta.length)){var i={type:"anchor-meta",frame:a,anchor:l,meta:m.meta};this.dispatchEvent(i)}}}}}),this.vertexBufferStart=0,this.vertexBufferLength=0,a.frameData&&(this.frame=0,this.totalFrames=a.frameData.length),this.dispose=function(a){this.geometry&&((a||this.geometry.data&&!this.geometry.data.name)&&(this.geometry.data&&(THREE.PixelBoxUtil.dispose(this.geometry.data),delete this.geometry.data),this.geometry.dispose()),delete this.geometry,this.material.dispose(),this.customDepthMaterial.dispose())},this.currentAnimation=null,this._animSpeed=1,Object.defineProperty(this,"animSpeed",{get:function(){return this._animSpeed},set:function(a){if(this._animSpeed=a,this._animationInterval&&this.currentAnimation){var b=1/(Math.abs(a?a:.001)*this.currentAnimation.fps);this._animationInterval=b,renderer.animQueue.adjustTime(this.advanceAnimationFrame,b)}}}),this._animationInterval=0,this._animLoops=-1,this._currentAnimationPosition=0,Object.defineProperty(this,"currentAnimationPosition",{get:function(){return this._currentAnimationPosition},set:function(a){a=Math.min(1,Math.max(0,a));var b=Math.min(this.currentAnimation.length-1,Math.floor(a*this.currentAnimation.length));this.animSpeed<0&&(b=this.currentAnimation.length-1-b),this._currentAnimationPosition=a,this.frame=b+this.currentAnimation.start}}),this.advanceAnimationFrame=THREE.PixelBox.prototype.advanceAnimationFrame.bind(this),this.addEventListener("removed",this.stopAnim),Object.defineProperty(this,"asset",{get:function(){return this.geometry.data}}),Object.defineProperty(this,"alpha",{get:function(){return this.material.uniforms.tintAlpha.value},set:function(a){this.material.uniforms.tintAlpha.value=a}}),Object.defineProperty(this,"tint",{get:function(){return this.material.uniforms.tintColor.value},set:function(a){this.material.uniforms.tintColor.value.copy(a)}}),Object.defineProperty(this,"addColor",{get:function(){return this.material.uniforms.addColor.value},set:function(a){this.material.uniforms.addColor.value.copy(a)}}),Object.defineProperty(this,"occlusion",{get:function(){return this.material.uniforms.occlusion.value},set:function(a){this.material.uniforms.occlusion.value=a}}),Object.defineProperty(this,"pointSize",{get:function(){return this.material.uniforms.pointSize.value},set:function(a){this.material.uniforms.pointSize.value=a}}),Object.defineProperty(this,"stipple",{get:function(){return this.material.uniforms.stipple.value},set:function(a){this.material.uniforms.stipple.value=a}}),Object.defineProperty(this,"cullBack",{get:function(){return!!this.material.uniforms.cullBack.value},set:function(a){this.material.uniforms.cullBack.value=a?1:0}}),this.fasterRaycast=!0,void 0!==a.particles){for(var h=[],i=[],j=[],k=[],l=0;l<a.particles;l++)h.push(0,0,0),i.push(1,1,1,1),j.push(0,1,0),k.push(0);a.frameData.push({p:new THREE.BufferAttribute(new Float32Array(h),3),c:new THREE.BufferAttribute(new Float32Array(i),4),n:new THREE.BufferAttribute(new Float32Array(j),3),o:new THREE.BufferAttribute(new Float32Array(k),1)}),this.geometry._frame=-1,this.frame=0,this.geometry.computeBoundingSphere()}return this},THREE.PixelBox.prototype=Object.create(THREE.PointCloud.prototype),THREE.PixelBox.prototype.constructor=THREE.PixelBox,THREE.PixelBox.prototype.advanceAnimationFrame=function(){this._animationInterval=0;var a=1/(Math.abs(this.animSpeed?this.animSpeed:.001)*this.currentAnimation.fps),b=!0,c=this.currentAnimation.length>1?1/(this.currentAnimation.length-1):1;if(this.currentAnimationPosition+=c,this._animationInterval=0,1==this.currentAnimationPosition)if(this._animLoops>0){var d={type:"anim-loop",anim:this.currentAnimation,loop:this._animLoops};this.dispatchEvent(d),this._animLoops--,this._currentAnimationPosition=-c}else{b=!1;var d={type:"anim-finish",anim:this.currentAnimation};this.dispatchEvent(d)}b&&(this._animationInterval=a,renderer.animQueue.enqueue(this.advanceAnimationFrame,a))},THREE.PixelBox.prototype.playAnim=function(a,b){this.loopAnim(a,0,b)},THREE.PixelBox.prototype.loopAnim=function(a,b,c){var d=this.geometry.data.anims[a];if(!d)return void console.log("Animation "+a+" not found in ",this.data);if(this._animationInterval){if(this.currentAnimation==d&&this._animLoops>0)return void(this._animLoops=b);this.stopAnim()}this.currentAnimation=d,this._animLoops=void 0===b?1/0:b,this.currentAnimationPosition=c&&this.frame>=d.start&&this.frame<d.start+d.length?this.animSpeed>=0?(this.frame-d.start)/d.length:1-(this.frame-d.start)/d.length:0;var e={type:"anim-start",anim:this.currentAnimation};this.dispatchEvent(e),this.currentAnimation.meta.length&&(e={type:"anim-meta",anim:this.currentAnimation,meta:d.meta},this.dispatchEvent(e));var f=1/(Math.abs(this.animSpeed)*d.fps);this._animLoops--,this._animationInterval=f,renderer.animQueue.enqueue(this.advanceAnimationFrame,f)},THREE.PixelBox.prototype.gotoAndStop=function(a,b){var c=this.geometry.data.anims[a],d=this.currentAnimation!=c;if(b=void 0===b?0:b,!c)return void console.log("Animation "+a+" not found in ",this.data);if(this._animationInterval&&this.stopAnim(),d){var e={type:"anim-stop",anim:this.currentAnimation};this.dispatchEvent(e)}if(this.currentAnimation=c,this.currentAnimationPosition=1>b?b:b/c.length%1,this._animLoops=-1,d&&c.meta.length){var e={type:"anim-meta",anim:c,meta:c.meta};this.dispatchEvent(e)}},THREE.PixelBox.prototype.animNamed=function(a){return this.geometry.data.anims[a]},THREE.PixelBox.prototype.stopAnim=function(){if(this._animationInterval&&(renderer.animQueue.cancel(this.advanceAnimationFrame),this._animationInterval=0),this.currentAnimation){var a={type:"anim-stop",anim:this.currentAnimation};this.dispatchEvent(a),this.currentAnimation=null}},THREE.PixelBox.prototype.updateFrameWithCallback=function(a,b){var c=this.geometry,d=c.data,e=d.frameData[0],f=0,g={p:new THREE.Vector3,n:new THREE.Vector3,c:new THREE.Color,a:0,b:1,o:0},h=d.particles;for(f=0;h>f;f++)g.i=f,g.p.set(e.p.array[3*f],e.p.array[3*f+1],e.p.array[3*f+2]),g.n.set(e.n.array[3*f],e.n.array[3*f+1],e.n.array[3*f+2]),g.b=g.n.length()-1,g.n.normalize(),g.o=e.o.array[f],g.c.setRGB(e.c.array[4*f],e.c.array[4*f+1],e.c.array[4*f+2]),g.a=e.c.array[4*f+3],a(g,b),e.p.array[3*f]=g.p.x,e.p.array[3*f+1]=g.p.y,e.p.array[3*f+2]=g.p.z,e.o.array[f]=g.o,g.n.multiplyScalar(1+g.b),e.n.array[3*f]=g.n.x,e.n.array[3*f+1]=g.n.y,e.n.array[3*f+2]=g.n.z,e.c.array[4*f]=g.c.r,e.c.array[4*f+1]=g.c.g,e.c.array[4*f+2]=g.c.b,e.c.array[4*f+3]=g.a;e.c.needsUpdate=!0,e.n.needsUpdate=!0,e.o.needsUpdate=!0,e.p.needsUpdate=!0},THREE.PixelBox.prototype.appendPixelBox=function(a){if(-1!=this.geometry._frame)return void console.log("Unable to append - geometry already committed.");this.geometry.data.frameData||(this.geometry.data.frameData=[]),this.geometry.boundingBox||(this.geometry.boundingBox=new THREE.Box3),this.geometry.boundingSphere||(this.geometry.boundingSphere=new THREE.Sphere),a.updateMatrixWorld(!0);var b=a.matrixWorld.clone(),c=new THREE.Matrix4;c.getInverse(this.matrixWorld),c.multiply(b),b.copy(c);for(var d,e,f,g,h=[],i=[],j=[],k=[],l=a.geometry.data.frameData[0],m=a.geometry.offsets.length?a.geometry.offsets[0].index:0,n=m+(a.geometry.offsets.length?a.geometry.offsets[0].count:l.o.array.length),o=new THREE.Vector3,p=new THREE.Vector3,q=new THREE.Vector4,r=m;n>r;r++){o.set(l.p.array[3*r],l.p.array[3*r+1],l.p.array[3*r+2]),p.set(l.n.array[3*r],l.n.array[3*r+1],l.n.array[3*r+2]),q.set(l.c.array[4*r],l.c.array[4*r+1],l.c.array[4*r+2],l.c.array[4*r+3]),d=l.o.array[r]*a.occlusion,o.applyMatrix4(b),e=p.length();var f=Math.max(a.addColor.r,a.addColor.g,a.addColor.b);q.x=q.x*a.tint.r+a.addColor.r*f,q.y=q.y*a.tint.g+a.addColor.g*f,q.z=q.z*a.tint.b+a.addColor.b*f,q.w=q.w*a.alpha,p.normalize().transformDirection(b).multiplyScalar(Math.min(2,e+f)),h.push(o.x,o.y,o.z),i.push(q.x,q.y,q.z,q.w),j.push(p.x,p.y,p.z),k.push(d),g=this.geometry.boundingBox.min,g.set(Math.min(g.x,o.x),Math.min(g.y,o.y),Math.min(g.z,o.z)),g=this.geometry.boundingBox.max,g.set(Math.max(g.x,o.x),Math.max(g.y,o.y),Math.max(g.z,o.z)),g=this.geometry.boundingSphere.radius,this.geometry.boundingSphere.radius=Math.max(g,o.length())}this.geometry.data.frameData.push({p:h,n:j,c:i,o:k})},THREE.PixelBoxUtil={},THREE.PixelBoxUtil.material=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.shadowmap,THREE.UniformsLib.lights,THREE.PixelBoxShader.uniforms]),attributes:THREE.PixelBoxShader.attributes,vertexShader:THREE.PixelBoxShader.vertexShader,fragmentShader:THREE.PixelBoxShader.fragmentShader,transparent:!1,lights:!0,fog:!0}),THREE.PixelBoxUtil.depthMaterial=new THREE.ShaderMaterial({uniforms:THREE.PixelBoxDepthShader.uniforms,vertexShader:THREE.PixelBoxDepthShader.vertexShader,fragmentShader:THREE.PixelBoxDepthShader.fragmentShader}),THREE.PixelBoxUtil.depthMaterial._shadowPass=!0,THREE.PixelBoxUtil.meshDepthMaterial=new THREE.ShaderMaterial({uniforms:THREE.PixelBoxMeshDepthShader.uniforms,vertexShader:THREE.PixelBoxMeshDepthShader.vertexShader,fragmentShader:THREE.PixelBoxMeshDepthShader.fragmentShader}),THREE.PixelBoxUtil.meshDepthMaterial._shadowPass=!0,THREE.PixelBoxUtil.updateViewPortUniform=function(a){function b(a){return c.setFromMatrixScale(a.matrixWorld),a instanceof THREE.PerspectiveCamera?renderer.webgl.domElement.height/(2*Math.tan(.5*a.fov*Math.PI/180))/c.x:a.zoom*renderer.webgl.domElement.height/(2*a.top)/c.x}var c=new THREE.Vector3,d=1;if(renderer.scene instanceof THREE.PixelBoxSceneTransition&&renderer.scene.sceneA instanceof THREE.PixelBoxScene){var e=renderer.scene.smoothTime,f=b(renderer.scene.sceneB.camera);d=b(renderer.scene.sceneA.camera),d+=(f-d)*e}else a?d=b(a):renderer.currentScene&&renderer.currentScene.camera&&(d=b(renderer.currentScene.camera));THREE.PixelBoxUtil.material.uniforms.viewPortScale.value=d},THREE.PixelBoxUtil.dispose=function(a){if(a&&a.frameData){for(var b=renderer.webgl.context,c=0;c<a.frameData.length;c++)if(a.frameData[c].p)for(var d in a.frameData[c])void 0!==a.frameData[c][d].buffer&&(b.deleteBuffer(a.frameData[c][d].buffer),delete a.frameData[c][d]);delete a.frameData,a.name&&assets.files[a.name]==a&&assets.remove(a.name)}},THREE.PixelBoxUtil.processPixelBoxFrames=function(a){if(null===a.frames||void 0!==a.particles)return a.frameData=[],!0;if(a.frames){if(!a.frames.length)return!1;var b=new THREE.Vector3;if(a.anchors&&a.anchors.PIVOT?b.set(a.anchors.PIVOT[0].x,a.anchors.PIVOT[0].y,a.anchors.PIVOT[0].z):b.set(.5*a.width,.5*a.height,.5*a.depth),!a.frameData){a.frameData=[];for(var c=0;c<a.frames.length;c++)a.frameData[c]=THREE.PixelBoxUtil.decodeFrame(a,c);THREE.PixelBoxUtil.finalizeFrames(a,b)}if(_.isArray(a.anims)){for(var d={},e=0;e<a.anims.length;e++)d[a.anims[e].name]=a.anims[e];a.anims=d}return delete a.frames,!0}return!1},THREE.PixelBoxUtil.updateLights=function(a,b){var c=THREE.PixelBoxUtil.material.uniforms;c.actualHemiLights.value=0,c.actualDirLights.value=0,c.actualPointLights.value=0,c.actualSpotLights.value=0,c.directionalLightShadowMap.value.length=0,c.spotLightShadowMap.value.length=0;var d=0;a.traverse(function(a){a.visible&&(a instanceof THREE.SpotLight?(c.actualSpotLights.value++,c.spotLightShadowMap.value.push(a.castShadow&&renderer.webgl.shadowMapEnabled?++d:0)):a instanceof THREE.DirectionalLight?(c.actualDirLights.value++,c.directionalLightShadowMap.value.push(a.castShadow&&renderer.webgl.shadowMapEnabled?++d:0)):a instanceof THREE.HemisphereLight?c.actualHemiLights.value++:a instanceof THREE.PointLight&&c.actualPointLights.value++),b&&a.material&&(a.material.needsUpdate=!0)}),c.directionalLightShadowMap.value.length||c.spotLightShadowMap.value.push(0),c.spotLightShadowMap.value.length||c.spotLightShadowMap.value.push(0)},THREE.PixelBoxUtil.decodeFrame=function(a,b){function c(a,b,c,d,e,g){a+=d,b+=e,c+=g;var h=0>a||0>c||a>=l||c>=n,i=0>b||b>=m;return f&&h?new THREE.Vector3(0,0,0):h||i||0==t[a*n*m+b*n+c].a?new THREE.Vector3(d,e,g):new THREE.Vector3(0,0,0)}function d(a,b,c){var d=a*n*m+b*n+c;return 0>a||0>b||0>c||a>=l||b>=m||c>=n?0:t[d].a}var e=void 0!=a.smoothNormals?a.smoothNormals:1,f=void 0!=a.floor?a.floor:!1,g=void 0!=a.optimize?a.optimize:!0,h=[],i=[],j=[],k=[],l=a.width,m=a.height,n=a.depth,o=.5*l,p=.5*m,q=.5*n,r=a.frames[b],s=null,t=[],u="object"==typeof a.frames[0]&&void 0!=a.frames[0].p,v=b>0;if(u)h=r.p,i=r.c,j=r.n,k=r.o;else{if(v){r=r.match(/.{14}/g);for(var w=b-1;!s;)s=a.frames[w],w--}else r=r.match(/.{8}/g);var x=!1;null===r&&(r=[],x=!0);for(var y,z,A,B=0,C=0,D=new THREE.Color,E=new THREE.Vector3,F=new THREE.Vector3,G=new THREE.Vector3,H=0;l>H;H++)for(var I=0;m>I;I++)for(var J=0;n>J;J++)v?(A=s[C],A={c:A.c,a:A.a,b:A.b},t.push(A)):(y=r[C],A={c:parseInt(y.substr(0,6),16),a:parseInt(y.substr(6,1),16)/15,b:parseInt(y.substr(7,1),16)/15},t.push(A)),C++;if(v)for(C=0;C<r.length;C++)y=r[C],z=parseInt(y.substr(0,6),16),t[z]={c:parseInt(y.substr(6,6),16),a:parseInt(y.substr(12,1),16)/15,b:parseInt(y.substr(13,1),16)/15};if(x||(a.frames[b]=t),x)return null;C=0;for(var K,H=0;l>H;H++)for(var I=0;m>I;I++)for(var J=0;n>J;J++)if(0!=t[C].a){K=[d(H-1,I,J),d(H+1,I,J),d(H,I-1,J),d(H,I+1,J),d(H,I,J-1),d(H,I,J+1)];var L=Math.floor(K[0])+Math.floor(K[1])+Math.floor(K[2])+Math.floor(K[3])+Math.floor(K[4])+Math.floor(K[5]);if(g&&6==L&&d(H-2,I,J)+d(H+2,I,J)+d(H,I-2,J)+d(H,I+2,J)+d(H,I,J-2)+d(H,I,J+2)==6)B++,C++;else{L>2?(F=f?new THREE.Vector3(0,1,0):new THREE.Vector3(H-o,I-p,J-q),F.normalize().multiplyScalar(.1)):F=new THREE.Vector3(0,1,0),F.add(c(H,I,J,1,0,0)),F.add(c(H,I,J,-1,0,0)),F.add(c(H,I,J,0,1,0)),F.add(c(H,I,J,0,-1,0)),F.add(c(H,I,J,0,0,1)),F.add(c(H,I,J,0,0,-1));var M;e>0&&(M=.25*e,F.add(c(H,I,J,2,0,0).multiplyScalar(M)),F.add(c(H,I,J,-2,0,0).multiplyScalar(M)),F.add(c(H,I,J,0,2,0).multiplyScalar(M)),F.add(c(H,I,J,0,-2,0).multiplyScalar(M)),F.add(c(H,I,J,0,0,2).multiplyScalar(M)),F.add(c(H,I,J,0,0,-2).multiplyScalar(M)),M=.4*e,F.add(c(H,I,J,1,1,0).multiplyScalar(M)),F.add(c(H,I,J,0,1,1).multiplyScalar(M)),F.add(c(H,I,J,1,1,1).multiplyScalar(M)),F.add(c(H,I,J,-1,-1,0).multiplyScalar(M)),F.add(c(H,I,J,0,-1,-1).multiplyScalar(M)),F.add(c(H,I,J,-1,-1,-1).multiplyScalar(M))),0==F.length()?F.set(0,1,0):F.normalize();var N=0;if(L>2){M=.125;for(var O=0;6>O;O++)N+=K[O];N*=.25/6,N+=1*d(Math.round(H+F.x),Math.round(I+F.y),Math.round(J+F.z)),ax=Math.abs(F.x),ay=Math.abs(F.y),az=Math.abs(F.z),mv=Math.min(ax,ay,az),mv==ax?E.set(1,0,0):mv==ay?E.set(0,1,0):E.set(0,0,1),E.cross(F).normalize(),G.copy(F).applyAxisAngle(E,.2*Math.PI).normalize().multiplyScalar(2),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.copy(F).applyAxisAngle(E,.35*Math.PI).normalize().multiplyScalar(3.5),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),G.applyAxisAngle(F,.25*Math.PI),N+=.5*M*d(Math.round(H+G.x),Math.round(I+G.y),Math.round(J+G.z)),N/=3}else N=.25*-L;k.push(N),F.multiplyScalar(1+t[C].b),D.set(t[C].c),i.push(D.r,D.g,D.b,t[C].a),h.push(H,I,J),j.push(F.x,F.y,F.z),C++}}else C++}return{p:h,c:i,n:j,o:k}},THREE.PixelBoxUtil.finalizeFrames=function(a,b,c){for(var d=a.frameData[0],e=0,f=0,g=0;g<a.frameData.length;g++){var h=a.frameData[g];h?(f=g,h.s=e,h.l=h.o.length,e+=h.o.length):a.frameData[g]=a.frameData[f],g&&h&&(d.p=d.p.concat(h.p),d.c=d.c.concat(h.c),d.n=d.n.concat(h.n),d.o=d.o.concat(h.o),delete h.p,delete h.c,delete h.n,delete h.o)}for(var i=0,j=d.p.length;j>i;i+=3)d.p[i]-=b.x,d.p[i+1]-=b.y,d.p[i+2]-=b.z;c&&a.frameData.length>1&&(a.frameData.splice(1,a.frameData.length-1),d.s=0,d.l=d.o.length),d.p=new THREE.BufferAttribute(new Float32Array(d.p),3),d.c=new THREE.BufferAttribute(new Float32Array(d.c),4),d.n=new THREE.BufferAttribute(new Float32Array(d.n),3),d.o=new THREE.BufferAttribute(new Float32Array(d.o),1)},THREE.PixelBoxUtil.encodeFrame=function(a,b){var c=b.frames.length;void 0===b.assembledFrames&&(b.assembledFrames=[]),b.assembledFrames.push(a);for(var d,e=[],f=0,g=0;g<b.width;g++)for(var h=0;h<b.height;h++)for(var i=0;i<b.depth;i++){var j=a[f];j=j?j:{c:0,a:0,b:0};var k=("00000"+new Number(j.c).toString(16)).substr(-6),l=new Number(Math.floor(15*j.a)).toString(16),m=new Number(Math.floor(15*j.b)).toString(16);c?(d=b.assembledFrames[c-1][f],d=d?d:{c:0,a:0,b:0},(d.c!=j.c||d.a!=j.a||d.b!=j.b)&&e.push(("00000"+new Number(f).toString(16)).substr(-6)+k+l+m)):e.push(k+l+m),f++}b.frames.push(e.join(""))},THREE.PixelBoxUtil.parseXml=function(){var a=null;return"undefined"!=typeof window.DOMParser?a=function(a){return(new window.DOMParser).parseFromString(a,"text/xml")}:"undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")&&(a=function(a){var b=new window.ActiveXObject("Microsoft.XMLDOM");return b.async="false",b.loadXML(a),b}),a}(),THREE.PixelBoxUtil.parsePlist=function(a){function b(a){switch(a.nodeName.toLowerCase()){case"dict":return c(a);case"string":var d=a.textContent;if("{"==d.substr(0,1)){var e=d.match(/\{\{(-?\d+),\s?(-?\d+)\},\s?\{(-?\d+),\s?(-?\d+)\}\}/);if(e&&5==e.length)return{x:parseInt(e[1]),y:parseInt(e[2]),width:parseInt(e[3]),height:parseInt(e[4])};if(e=d.match(/\{(-?\d+),\s?(-?\d+)\}/),e&&3==e.length)return{x:parseInt(e[1]),y:parseInt(e[2])}}return d;case"true":return!0;case"false":return!1;case"integer":return parseInt(a.textContent);case"array":for(var f=a.childNodes,g=[],h=0;h<f.length;h++)3!=f[h].nodeType&&g.push(b(f[h]));return g}}function c(a){for(var c=a.childNodes,d={},e=0;e<c.length;e++)if(3!=c[e].nodeType){var f=c[e].textContent;for(e++;e<c.length-1&&3==c[e].nodeType;)e++;var g=b(c[e]);d[f]=g}return d}var d,e=THREE.PixelBoxUtil.parseXml(a);for(var f in e.documentElement.childNodes)if("dict"==e.documentElement.childNodes[f].nodeName){d=e.documentElement.childNodes[f];break}var g=c(d);return g},THREE.FxSprite=function(){THREE.Object3D.apply(this),this.material=new THREE.MeshPixelBoxMaterial({defines:{BILLBOARD:1}}),this.material.side=THREE.DoubleSide,this._textureMap=null,Object.defineProperty(this,"textureMap",{get:function(){return this._textureMap},set:function(a){this._textureMap=a;var b=assets.get(a);if(b?b instanceof THREE.Texture?(this.material.map=b,b.needsUpdate=!0):b.image&&(b.texture||(b.texture=new THREE.Texture(b.image)),this.material.map=b.texture,b.texture.needsUpdate=!0,b=b.texture):this.material.map=null,this.reset(),b){var c=b.sliceMap;if(!c)for(var d in assets.files){var e=assets.files[d];if(e.metadata&&e.metadata.textureFileName==this._textureMap){c=b.sliceMap=e;break}if(e.plist&&e.plist.metadata&&e.plist.metadata.textureFileName==this._textureMap){c=b.sliceMap=e.plist;break}}if(!c){var f=this.createSprite(null);this.add(f)}}}}),this.reset=function(){for(;this.children.length;){var a=this.children[0];this.remove(a),a.material.dispose(),a.customDepthMaterial.dispose()}this.layers={}}.bind(this),this._fxData=null,Object.defineProperty(this,"fxData",{get:function(){return this._fxData?this._fxData.name:null},set:function(a){var b=this._fxData=assets.get(a);if(this.reset(),b){if(!b.ready){for(var c=0;c<b.layerAnims.length;c++)for(var d="",e=0;e<b.layerAnims[c].length;e++){var f=b.layerAnims[c][e];void 0!==f.s&&""!==f.s?d=f.s:""===f.s&&(f.s=d),f.rx=void 0!==f.rx?f.rx:0,f.ry=void 0!==f.ry?f.ry:0,f.tx=void 0!==f.tx?f.tx:0,f.ty=void 0!==f.ty?f.ty:0,f.h=f.h?!0:!1,f.c=f.h?"100,100,100,0,0,0,0,0":(void 0!==f.c?f.c:"100,100,100,100,0,0,0,0").split(",");for(var g=0;8>g;g++)f.c[g]=parseFloat(f.c[g])}for(var h=new Array,i=0;i<b.frameLabels.length;i++)h[b.frameLabels[i].f]=b.frameLabels[i].l;b.animations={};for(var j=null,k=0,l=b.layerAnims[0].length;l>k;k++)h[k]?(j&&(b.animations[j.name]=j),j={name:h[k],start:k,length:1,fps:b.fps}):j&&j.length++;j&&(b.animations[j.name]=j),b.comments=new Array;for(var i=0;i<b.frameComments.length;i++)b.comments[b.frameComments[i].f]=b.frameComments[i].c;if(b.symbols.length){for(var m={},i=0;i<b.symbols.length;i++)m[b.symbols[i].name]=b.symbols[i];b.symbols=m}b.ready=!0}this.animations=b.animations,this.frameComments=b.comments;var n;for(var i in b.symbols){n=i;break}for(var i=0;i<b.layerNames.length;i++){var o=b.symbols[n],p=o.name;o.frames.length>1&&(p+="0001");var q=this.createSprite(p+".png");q.name=b.layerNames[i],q.index=i,q.frame=-1,this.layers[q.name]=q,this.add(q),this.setLayerFrame(q,0,0,0)}}}}),this.currentAnimation=null,this.animSpeed=1,this._animationInterval=0,this._animLoops=-1,this._currentAnimationPosition=0,Object.defineProperty(this,"currentAnimationPosition",{get:function(){return this._currentAnimationPosition},set:function(a){var b,c,d;if(this._animLoops>0)b=a*this.currentAnimation.length,c=Math.floor(b),b-=Math.floor(b),d=c>=this.currentAnimation.length-1?0:c+1,c%=this.currentAnimation.length,d%=this.currentAnimation.length;else{var b=a*this.currentAnimation.length,c=Math.floor(b);b-=Math.floor(b),c=Math.max(0,Math.min(c,this.currentAnimation.length-1)),d=Math.min(c+1,this.currentAnimation.length-1)}this.animSpeed<0&&(c=this.currentAnimation.length-1-c,d=this.currentAnimation.length-1-d),this._currentAnimationPosition=a,c+=this.currentAnimation.start,d+=this.currentAnimation.start;for(var e=0,f=this.children.length;f>e;e++)this.setLayerFrame(this.children[e],b,c,d);if(this.frame!=c){this.frame=c;var g={type:"frame",frame:c};this.dispatchEvent(g),this.frameComments[c]&&(g={type:"frame-meta",frame:c,meta:this.frameComments[c]},this.dispatchEvent(g))}}}),this._scaleX=1,this._scaleY=1,this._scale2d=new THREE.Vector3(1,1,1),this._angle=0,this.spriteTransform=new THREE.Matrix4,this.updateMatrix=function(){this.matrix.makeTranslation(this.position.x,this.position.y,this.position.z),this._scale2d.x=this._scaleX,this._scale2d.y=this._scaleY,this.spriteTransform.makeRotationZ(this._angle).scale(this._scale2d),this.matrixWorldNeedsUpdate=!0}.bind(this),Object.defineProperty(this,"scaleX",{get:function(){return this._scaleX},set:function(a){this._scaleX=a,this.cascadeColorChange(),this.updateMatrix()}}),Object.defineProperty(this,"scaleY",{get:function(){return this._scaleY},set:function(a){this._scaleY=a,this.cascadeColorChange(),this.updateMatrix()}}),Object.defineProperty(this,"angle",{get:function(){return this._angle},set:function(a){this._angle=a,this.updateMatrix()}}),Object.defineProperty(this,"stipple",{get:function(){return this.material.uniforms.stipple.value},set:function(a){this.material.uniforms.stipple.value=a}}),Object.defineProperty(this,"brightness",{get:function(){return this.material.uniforms.brightness.value},set:function(a){this.material.uniforms.brightness.value=a}}),Object.defineProperty(this,"alphaThresh",{get:function(){return this.material.uniforms.alphaThresh.value},set:function(a){this.material.uniforms.alphaThresh.value=a}}),this.cascadeColorChange=THREE.FxSprite.prototype.cascadeColorChange.bind(this),Object.defineProperty(this,"alpha",{get:function(){return this.material.uniforms.tintAlpha.value},set:function(a){this.material.uniforms.tintAlpha.value=a,this.cascadeColorChange()}}),Object.defineProperty(this,"tint",{get:function(){return requestAnimationFrame(this.cascadeColorChange),this.material.uniforms.tintColor.value},set:function(a){this.material.uniforms.tintColor.value=a,this.cascadeColorChange()}}),Object.defineProperty(this,"addColor",{get:function(){return requestAnimationFrame(this.cascadeColorChange),this.material.uniforms.addColor.value},set:function(a){this.material.uniforms.addColor.value=a,this.cascadeColorChange()}}),this.advanceAnimationFrame=THREE.FxSprite.prototype.advanceAnimationFrame.bind(this),this.setLayerFrame=THREE.FxSprite.prototype.setLayerFrame.bind(this),this.addEventListener("removed",this.stopAnim)},THREE.FxSprite.prototype=Object.create(THREE.Object3D.prototype),THREE.FxSprite.prototype.constructor=THREE.FxSprite,THREE.FxSprite.prototype.createSprite=function(a){var b,c,d=this.material.map.sliceMap,e=d?d.frames[a]:null;e?(b=e.spriteSourceSize.x,c=e.spriteSourceSize.y):(b=this.material.map.image.width,c=this.material.map.image.height);var f=new THREE.PlaneGeometry(b,c),g=new THREE.MeshPixelBoxMaterial({defines:{BILLBOARD:1}});g.side=this.material.side,g.uniforms.alphaThresh=this.material.uniforms.alphaThresh,g.uniforms.brightness=this.material.uniforms.brightness,g.uniforms.stipple=this.material.uniforms.stipple,g.map=this.material.map;var h=new THREE.Mesh(f,g);return h.customDepthMaterial=THREE.PixelBoxUtil.meshDepthMaterial.clone(),h.customDepthMaterial.defines=g.defines,h.customDepthMaterial.needsUpdate=!0,h.customDepthMaterial.map=h.customDepthMaterial.uniforms.map=g.uniforms.map,h.customDepthMaterial.uniforms.tintAlpha=g.uniforms.tintAlpha,h.customDepthMaterial.uniforms.alphaThresh=g.uniforms.alphaThresh,h.customDepthMaterial.uniforms.uvSliceRect=g.uniforms.uvSliceRect,h.customDepthMaterial.uniforms.uvSliceOffset=g.uniforms.uvSliceOffset,h.customDepthMaterial.uniforms.uvSliceSizeIsRotated=g.uniforms.uvSliceSizeIsRotated,h.customDepthMaterial._shadowPass=!0,h.castShadow=this.castShadow,h.receiveShadow=this.receiveShadow,h.customDepthMaterial.uniforms.localMatrix.value=g.uniforms.localMatrix.value=h.matrix,h.customDepthMaterial.uniforms.parentWorldMatrix.value=g.uniforms.parentWorldMatrix.value=this.matrixWorld,h.customDepthMaterial.uniforms.spriteTransform.value=g.uniforms.spriteTransform.value=this.spriteTransform,e&&(h.material.slice=e),h.symbolOverride=null,h.flipped=!1,h.targetA=1,h.targetAddR=h.targetAddG=h.targetAddB=0,h.targetTintR=h.targetTintG=h.targetTintB=0,h.omit=!0,h.matrixAutoUpdate=!0,h.updateMatrix=function(){},h.updateMatrixWorld=function(){return function(){var a=new THREE.Matrix4;
if(this.children.length){a.extractRotation(renderer.currentScene.camera.matrixWorld),this.matrixWorld.identity().multiply(this.parent.matrixWorld).multiply(a),this.matrixWorld.multiply(this.parent.spriteTransform).multiply(this.matrix);for(var b=0,c=this.children.length;c>b;b++)this.children[b].updateMatrixWorld(!0)}}}(),h},THREE.FxSprite.prototype.cascadeColorChange=function(){for(var a=this._scaleX<0^this._scaleY<0,b=this.children.length-1;b>=0;b--){var c=this.children[b];c.material.uniforms.tintAlpha.value=this.material.uniforms.tintAlpha.value*c.targetA;var d=c.material.uniforms.tintColor.value;d.copy(this.material.uniforms.tintColor.value),d.r*=c.targetTintR,d.g*=c.targetTintG,d.b*=c.targetTintB,d=c.material.uniforms.addColor.value,d.copy(this.material.uniforms.addColor.value),d.r+=c.targetAddR,d.g+=c.targetAddG,d.b+=c.targetAddB,c.castShadow=this.castShadow,c.receiveShadow=this.receiveShadow,c.material.flipSided=!a}},THREE.FxSprite.prototype.advanceAnimationFrame=function(){this._animationInterval=0;var a=1/(10*this.currentAnimation.fps),b=!0,c=Math.abs(this.animSpeed)*(this.currentAnimation.length>1?1/(this.currentAnimation.length-1):1);if(this.currentAnimationPosition+=c,this._animationInterval=0,this._currentAnimationPosition>=1)if(this._animLoops>0){var d={type:"anim-loop",anim:this.currentAnimation,loop:this._animLoops};this.dispatchEvent(d),this._animLoops--,this._currentAnimationPosition=0}else{b=!1;var d={type:"anim-finish",anim:this.currentAnimation};this.dispatchEvent(d)}b&&(this._animationInterval=a,renderer.animQueue.enqueue(this.advanceAnimationFrame,a))},THREE.FxSprite.prototype.setLayerFrame=function(a,b,c,d){var e=this._fxData.layerAnims[0].length,f=this._fxData.layerAnims[a.index][Math.max(0,Math.min(c,e-1))],g=this._fxData.layerAnims[a.index][Math.max(0,Math.min(d,e-1))],h=null;if(a.symbolOverride&&this._fxData.symbols[a.symbolOverride]?h=this._fxData.symbols[a.symbolOverride]:f.s&&(h=this._fxData.symbols[f.s]),a.currentSymbolFrameNumber!=f.f||h&&a.currentSymbolName!=h.name){if(h){var i=h.name;h.frames.length>1&&(i+=("000"+(f.f%h.frames.length+1)).substr(-4));var j=a.material.map.sliceMap.frames[i+".png"];a.material.slice=j;var k=h.frames[f.f];a.geometry.vertices[0].set(k[0],-k[1],0),a.geometry.vertices[1].set(k[0]+k[2],-k[1],0),a.geometry.vertices[2].set(k[0],-(k[1]+k[3]),0),a.geometry.vertices[3].set(k[0]+k[2],-(k[1]+k[3]),0),a.geometry.verticesNeedUpdate=!0,a.currentSymbolName=h.name}else a.currentSymbolName=null;a.currentSymbolFrameNumber=f.f}var l=g.h||f.h||!h;a.visible=!l,f.m&&f.m==g.m||(b=0);var m=f.x+(g.x-f.x)*b,n=-(f.y+(g.y-f.y)*b),o=f.tx+(g.tx-f.tx)*b,p=-(f.ty+(g.ty-f.ty)*b),q=f.sx+(g.sx-f.sx)*b,r=f.sy+(g.sy-f.sy)*b,s=f.rx,t=f.ry;s>90&&g.rx<-90?s=g.rx-(180+g.rx+180-f.rx):-90>s&&g.rx>90&&(s=g.rx+(180+f.rx+180-g.rx)),t>90&&g.ry<-90?t=g.ry-(180+g.ry+180-f.ry):-90>t&&g.ry>90&&(t=g.ry+(180+f.ry+180-g.ry));var u=.017452778*(s+(g.rx-s)*b),v=.017452778*(t+(g.ry-t)*b),w=1,x=0,y=1,z=0;(u||v)&&(u=-u,v=-v,w=Math.cos(u),x=Math.sin(u),y=Math.cos(v),z=Math.sin(v)),(o||p)&&(m+=y*-o*q-x*-p*r,n+=z*-o*q+w*-p*r),a.matrix.identity(),a.matrix.elements[0]=y*q,a.matrix.elements[1]=z*q,a.matrix.elements[4]=-x*r,a.matrix.elements[5]=w*r,a.matrix.elements[12]=m,a.matrix.elements[13]=n,a.matrix.elements[14]=.1*-a.index;var A=a.targetA=.01*(f.c[3]+(g.c[3]-f.c[3])*b);a.material.uniforms.tintAlpha.value=this.material.uniforms.tintAlpha.value*A;var B=a.material.uniforms.tintColor.value;B.copy(this.material.uniforms.tintColor.value),B.r*=a.targetTintR=.01*f.c[0]+(g.c[0]-f.c[0])*b,B.g*=a.targetTintG=.01*f.c[1]+(g.c[1]-f.c[1])*b,B.b*=a.targetTintB=.01*f.c[2]+(g.c[2]-f.c[2])*b,B=a.material.uniforms.addColor.value,B.copy(this.material.uniforms.addColor.value),B.r+=a.targetAddR=.01*f.c[4]+(g.c[4]-f.c[4])*b,B.g+=a.targetAddG=.01*f.c[5]+(g.c[5]-f.c[5])*b,B.b+=a.targetAddB=.01*f.c[6]+(g.c[6]-f.c[6])*b,a.castShadow=this.castShadow,a.receiveShadow=this.receiveShadow},THREE.FxSprite.prototype.playAnim=function(a,b){this.loopAnim(a,0,b)},THREE.FxSprite.prototype.loopAnim=function(a,b,c){var d=this.animations[a];if(!d)return void console.log("Animation "+a+" not found in ",this.data);if(this._animationInterval){if(this.currentAnimation==d&&this._animLoops>0)return void(this._animLoops=b);this.stopAnim()}this.currentAnimation=d,this._animLoops=void 0===b?1/0:b,this.currentAnimationPosition=c&&this.frame>=d.start&&this.frame<d.start+d.length?this.animSpeed>=0?(this.frame-d.start)/d.length:1-(this.frame-d.start)/d.length:0;var e={type:"anim-start",anim:this.currentAnimation};this.dispatchEvent(e);var f=1/(10*d.fps);this._animLoops--,this._animationInterval=f,renderer.animQueue.enqueue(this.advanceAnimationFrame,f)},THREE.FxSprite.prototype.gotoAndStop=function(a,b){var c=this.animations[a],d=this.currentAnimation!=c;if(b=void 0===b?0:b,!c)return void console.log("Animation "+a+" not found in ",this.data);if(this._animationInterval&&this.stopAnim(),d){var e={type:"anim-stop",anim:this.currentAnimation};this.dispatchEvent(e)}this.currentAnimation=c,this.currentAnimationPosition=1>b?b:b/c.length%1,this._animLoops=-1},THREE.FxSprite.prototype.animNamed=function(a){return this.animations[a]},THREE.FxSprite.prototype.stopAnim=function(){if(this._animationInterval&&(renderer.animQueue.cancel(this.advanceAnimationFrame),this._animationInterval=0),this.currentAnimation){var a={type:"anim-stop",anim:this.currentAnimation};this.dispatchEvent(a),this.currentAnimation=null}},THREE.PixelBoxAssets=function(){this.loadAssets=function(a){this.textures=a.textures?a.textures:[],this.scenedata=a.scenes?a.scenes:[],this.models=a.assets?a.assets:[],this.json=a.json?a.json:[],this.xml=a.xml?a.xml:[],this.plist=a.plist?a.plist:[],this.custom=a.custom?a.custom:[],this.other=a.other?a.other:[],this.onprogress=a.progress,this.onloaded=a.done,this.totalLoaded=0,this.totalAssets=this.textures.length+this.scenedata.length+this.models.length+this.json.length+this.plist.length+this.xml.length+this.custom.length+this.other.length;for(var b=0;b<this.custom.length;b++){var c=this.custom[b],d=function(a){return function(){if(!a.start)throw"Assets custom loading object - .start( obj, callOnDone ) function not specified.";a.start(a,assets.assetLoaded)}}(c);this.loadQueue.push(d)}for(var b=0;b<this.other.length;b++){var e,f=this.other[b],g=null;if("object"==typeof f){if(f.url&&f.parse)throw"Assets other loading object - .url and .parse are required.";e=f.url,g=f.parse}else e=f;var d=function(a,b){return function(){var c=new XMLHttpRequest;c.open("GET",a,!0),c.onload=function(){if(0===c.status&&c.responseText||c.status>=200&&c.status<400){var d=c.responseText;b&&(d=b(d)),assets.add(a,d),assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+c.status+" - "+c.statusText)},c.onerror=function(){console.error("Connection error while loading "+a)},c.send()}}(e,g);this.loadQueue.push(d)}for(var b=0;b<this.textures.length;b++){var e=this.textures[b],d=function(a){return function(){assets.add(a.split("/").pop(),new THREE.ImageUtils.loadTexture(a,void 0,assets.assetLoaded))}}(e);this.loadQueue.push(d)}for(var b=0;b<this.scenedata.length;b++){var e=this.scenedata[b],d=function(a){return function(){var b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=function(){if(0===b.status&&b.responseText||b.status>=200&&b.status<400){var c,d=b.responseText;if(c="{"==d.substr(0,1)||"["==d.substr(0,1)?d:LZString.decompressFromBase64(d)){try{c=JSON.parse(c)}catch(e){console.error("Failed to parse JSON for "+a,e,c)}var f=a.match(/([\w\d_-]*)\.?[^\\\/]*$/i)[1];assets.add(f,c)}else console.error("Failed to LZString decompressFromBase64 "+a);assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+b.status+" - "+b.statusText)},b.onerror=function(){console.error("Connection error while loading "+a)},b.send()}}(e);this.loadQueue.push(d)}for(var b=0;b<this.models.length;b++){var e=this.models[b],d=function(a){return function(){var b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=function(){if(0===b.status&&b.responseText||b.status>=200&&b.status<400){var c,d=new Date,e=b.responseText;if(c="{"==e.substr(0,1)?e:LZString.decompressFromBase64(e)){try{c=JSON.parse(c)}catch(f){console.error("Failed to parse JSON for "+a,f,c)}console.log("["+c.name+"] decompress+parse time:"+((new Date).getTime()-d)),d=new Date,THREE.PixelBoxUtil.processPixelBoxFrames(c),assets.add(c.name,c),console.log("["+c.name+"] process time:"+((new Date).getTime()-d))}else console.error("Failed to LZString decompressFromBase64 "+a);assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+b.status+" - "+b.statusText)},b.onerror=function(){console.error("Connection error while loading "+a)},b.send()}}(e);this.loadQueue.push(d)}for(var b=0;b<this.json.length;b++){var e=this.json[b],d=function(a){return function(){var b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=function(){if(0===b.status&&b.responseText||b.status>=200&&b.status<400){var c,d=b.responseText;if(c="{"==d.substr(0,1)?d:LZString.decompressFromBase64(d)){try{c=JSON.parse(c)}catch(e){console.error("Failed to parse JSON for "+a,e,c)}assets.add(a.split("/").pop(),c)}else console.error("Failed to LZString decompressFromBase64 "+a);assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+b.status+" - "+b.statusText)},b.onerror=function(){console.error("Connection error while loading "+a)},b.send()}}(e);this.loadQueue.push(d)}for(var b=0;b<this.xml.length;b++){var e=this.xml[b],d=function(a){return function(){var b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=function(){if(0===b.status&&b.responseText||b.status>=200&&b.status<400){var c,d=b.responseText;c="<"==d.substr(0,1)?d:LZString.decompressFromBase64(d),c?(c=THREE.PixelBoxUtil.parseXml(c),assets.add(a.split("/").pop(),c)):console.error("Failed to LZString decompressFromBase64 "+a),assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+b.status+" - "+b.statusText)},b.onerror=function(){console.error("Connection error while loading "+a)},b.send()}}(e);this.loadQueue.push(d)}for(var b=0;b<this.plist.length;b++){var e=this.plist[b],d=function(a){return function(){var b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=function(){if(0===b.status&&b.responseText||b.status>=200&&b.status<400){var c,d=b.responseText;c="<"==d.substr(0,1)?d:LZString.decompressFromBase64(d),c?(c=THREE.PixelBoxUtil.parseXml(c),assets.add(a.split("/").pop(),c)):console.error("Failed to LZString decompressFromBase64 "+a),assets.assetLoaded()}else console.error("Failed to load "+a+", status: "+b.status+" - "+b.statusText)},b.onerror=function(){console.error("Connection error while loading "+a)},b.send()}}(e);this.loadQueue.push(d)}this.totalAssets?this.loadQueue[this.totalAssets-1]():this.onloaded&&setTimeout(this.onloaded,100)},this.assetLoaded=function(){assets.totalLoaded++,assets.loadQueue.pop(),assets.totalLoaded===assets.totalAssets?assets.onloaded&&setTimeout(assets.onloaded,100):(assets.onprogress&&assets.onprogress(100*assets.totalLoaded/assets.totalAssets),setTimeout(assets.loadQueue[assets.loadQueue.length-1],10))},this.unload=function(){for(var a in this.files){var b=this.files[a];b.frameData||b.frames?THREE.PixelBox.prototype.dispose(b):b instanceof THREE.Texture&&b.dispose()}this.clear(),console.log("All assets unloaded")},this.totalLoaded=0,this.totalAssets=0,this.loadQueue=[],this.objectLoader=new THREE.JSONLoader,this.files={},this.add=function(a,b){this.files[a]=b},this.get=function(a){return this.files[a]},this.remove=function(a){delete this.files[a]},this.clear=function(){this.files={}}};var assets=new THREE.PixelBoxAssets;